<!DOCTYPE html>
<html>
  <head>
    <title>Viewstl Javascript Plugin - Simple Example</title>
    <style type="text/css" id="operaUserStyle"></style>
    <script src="https://www.viewstl.com/plugin/examples/three.min.js"></script>
    <style type="text/css">
      :root [href^="//mage98rquewz.com/"], :root [href^="//x4pollyxxpush.com/"], :root span[id^="ezoic-pub-ad-placeholder-"], :root ins.adsbygoogle[data-ad-slot], :root ins.adsbygoogle[data-ad-client], :root img[src^="https://s-img.adskeeper.com/"], :root guj-ad, :root gpt-ad, :root div[id^="zergnet-widget"], :root div[id^="vuukle-ad-"], :root div[id^="taboola-stream-"], :root div[id^="sticky_ad_"], :root div[id^="st"][style^="z-index: 999999999;"], :root div[id^="gpt_ad_"], :root div[id^="ezoic-pub-ad-"], :root div[id^="dfp-ad-"], :root div[id^="crt-"][style], :root div[id^="adspot-"], :root div[id^="adrotate_widgets-"], :root ps-connatix-module, :root div[id^="ad_position_"], :root div[id^="ad-div-"], :root div[id*="ScriptRoot"], :root div[id*="MarketGid"], :root div[data-id-advertdfpconf], :root div[data-dfp-id], :root hl-adsense, :root div[data-contentexchange-widget], :root div[data-alias="300x250 Ad 2"], :root div[data-adzone], :root div[data-adunit-path], :root div[data-adname], :root div[data-ad-targeting], :root div[data-ad-placeholder], :root div[aria-label="Ads"], :root display-ads, :root display-ad-component, :root atf-ad-slot, :root aside[id^="adrotate_widgets-"], :root amp-fx-flying-carpet, :root amp-embed[type="taboola"], :root amp-connatix-player, :root amp-ad-custom, :root amp-ad, :root div[id^="google_dfp_"], :root ad-slot, :root ad-shield-ads, :root a[style="width:100%;height:100%;z-index:10000000000000000;position:absolute;top:0;left:0;"], :root a[onmousedown^="this.href='https://paid.outbrain.com/network/redir?"] + .ob_source, :root a[href^="https://xbet-4.com/"], :root div[id^="ad-position-"], :root a[href^="https://www.toprevenuegate.com/"], :root a[href^="https://www.purevpn.com/"][href*="&utm_source=aff-"], :root a[href^="https://www.privateinternetaccess.com/"] > img, :root a[href^="https://www.onlineusershielder.com/"], :root a[href^="https://www.liquidfire.mobi/"], :root a[href^="https://www.infowarsstore.com/"] > img, :root a[href^="https://www.highperformancecpmgate.com/"], :root a[href^="https://www.highcpmrevenuenetwork.com/"], :root a[href^="https://lnkxt.bannerator.com/"], :root a[href^="https://www.geekbuying.com/dynamic-ads/"], :root a[href^="https://www.financeads.net/tc.php?"], :root a[href^="https://www.effectiveratecpm.com/"], :root [href^="https://www.herbanomic.com/"] > img, :root a[href^="https://maymooth-stopic.com/"], :root a[href^="https://www.dql2clk.com/"], :root a[href^="https://www.nutaku.net/signup/landing/"], :root a[href^="https://www.dating-finder.com/signup/?ai_d="], :root a[href^="https://explore-site.com/"], :root a[href^="https://www.brazzersnetwork.com/landing/"], :root a[href^="https://www.adxsrve.com/"], :root [data-template-type="nativead"], :root a[href^="https://www.endorico.com/Smartlink/"], :root a[href^="https://www.adultempire.com/"][href*="?partner_id="], :root a[href^="https://voluum.prom-xcams.com/"], :root a[href^="https://twinrdsrv.com/"], :root a[href^="https://trk.nfl-online-streams.club/"], :root a[href^="https://tracking.avapartner.com/"], :root a[href^="https://track.wg-aff.com"], :root a[href^="https://track.ultravpn.com/"], :root a[href^="https://track.afcpatrk.com/"], :root a[href^="https://torguard.net/aff.php"] > img, :root [data-identity="adhesive-ad"], :root a[href^="https://tc.tradetracker.net/"] > img, :root a[href^="https://tatrck.com/"], :root a[href^="https://click.candyoffers.com/"], :root [href^="https://zstacklife.com/"] img, :root a[href^="https://t.aslnk.link/"], :root a[href^="https://t.adating.link/"], :root a[href^="https://t.acam.link/"], :root a[href*="//daichoho.com/"], :root a[href^="https://syndication.optimizesrv.com/"], :root a[href^="https://go.trackitalltheway.com/"], :root [href^="https://track.fiverr.com/visit/"] > img, :root a[href^="https://syndication.exoclick.com/"], :root a[href^="https://syndication.dynsrvtbg.com/"], :root div[data-alias="300x250 Ad 1"], :root a[href^="https://syndicate.contentsserved.com/"], :root a[href^="https://svb-analytics.trackerrr.com/"], :root a[href^="https://ad.doubleclick.net/"], :root a[href^="https://static.fleshlight.com/images/banners/"], :root a[href^="https://slkmis.com/"], :root bottomadblock, :root a[href^="https://s.zlinkd.com/"], :root a[href^="https://s.zlink3.com/"], :root a[href^="https://www.mrskin.com/account/"], :root a[href^="https://s.optzsrv.com/"], :root a[href^="https://s.ma3ion.com/"], :root #kt_player > div[style$="display: block;"][style*="inset: 0px;"], :root [href$="/sexdating.php"], :root a[href^="https://quotationfirearmrevision.com/"], :root a[href^="https://pubads.g.doubleclick.net/"], :root a[href^="https://ak.oalsauwy.net/"], :root a[href^="https://softwa.cfd/"], :root a[href^="https://play1ad.shop/"], :root a[href^="https://prf.hn/click/"][href*="/camref:"] > img, :root a[href^="https://www.dating-finder.com/?ai_d="], :root a[href^="https://serve.awmdelivery.com/"], :root a[href^="https://prf.hn/click/"][href*="/adref:"] > img, :root app-ad, :root [href^="https://ap.octopuspop.com/click/"] > img, :root a[href^="https://postback1win.com/"], :root a[href^="https://mmwebhandler.aff-online.com/"], :root a[href^="https://www.bet365.com/"][href*="affiliate="], :root a[href^="https://pb-track.com/"], :root a[href^="https://pb-front.com/"], :root a[href^="https://paid.outbrain.com/network/redir?"], :root a[href^="https://streamate.com/landing/click/"], :root div[class^="Adstyled__AdWrapper-"], :root a[href^="https://osfultrbriolenai.info/"], :root a[href^="https://upsups.click/"], :root a[href^="https://ndt5.net/"], :root a[href^="http://eighteenderived.com/"], :root a[href^="https://natour.naughtyamerica.com/track/"], :root a[href^="https://mediaserver.entainpartners.com/renderBanner.do?"], :root a[href^="https://m.do.co/c/"] > img, :root .nya-slot[style], :root a[href^="https://a.bestcontentweb.top/"], :root a[href^="https://lobimax.com/"], :root a[href^="https://lead1.pl/"], :root a[href^="https://landing.brazzersnetwork.com/"], :root a[href^="https://join.virtuallust3d.com/"], :root a[href^="https://kiksajex.com/"], :root a[href^="https://juicyads.in/"], :root a[href^="https://snowdayonline.xyz/"], :root a[href^="https://mediaserver.gvcaffiliates.com/renderBanner.do?"], :root a[href^="https://join.dreamsexworld.com/"], :root a[href^="https://jaxofuna.com/"], :root a[href^="https://italarizege.xyz/"], :root a[href^="https://iqbroker.com/"][href*="?aff="], :root a[href^="https://identicaldrench.com/"], :root a[href^="https://hot-growngames.life/"], :root a[href^="https://helmethomicidal.com/"], :root a[href^="https://golinks.work/"], :root ark-top-ad, :root a[href^="https://s.zlinkn.com/"], :root a[href^="https://go.xxxvjmp.com/"], :root [class^="tile-picker__CitrusBannerContainer-sc-"], :root a[href^="https://go.xxxiijmp.com"], :root a[href^="https://go.xtbaffiliates.com/"], :root [data-role="tile-ads-module"], :root a[href^="https://go.xlviirdr.com"], :root a[href^="https://go.xlviiirdr.com"], :root a[href^="https://ismlks.com/"], :root [href^="https://www.mypillow.com/"] > img, :root a[href^="https://go.xlirdr.com"], :root [data-css-class="dfp-inarticle"], :root a[href^="https://l.hyenadata.com/"], :root a[href^="https://go.tmrjmp.com"], :root a[href^="https://zirdough.net/"], :root a[href^="https://s.deltraff.com/"], :root a[href^="https://go.markets.com/visit/?bta="], :root a[href^="https://billing.purevpn.com/aff.php"] > img, :root a[href^="https://go.hpyrdr.com/"], :root a[href^="https://lijavaxa.com/"], :root a[href^="https://go.goaserv.com/"], :root a[href^="https://t.hrtye.com/"], :root a[href^="https://go.etoro.com/"] > img, :root a[href^="https://go.dmzjmp.com"], :root a[href^="https://www.bang.com/?aff="], :root #mgb-container > #mgb, :root a[href^="https://go.admjmp.com"], :root a[href^="https://ak.stikroltiltoowi.net/"], :root a[href^="https://get.surfshark.net/aff_c?"][href*="&aff_id="] > img, :root a[href^="https://www.mrskin.com/tour"], :root a[href^="https://financeads.net/tc.php?"], :root a[href^="https://www.adskeeper.com"], :root a[data-redirect^="https://paid.outbrain.com/network/redir?"], :root [href^="https://clicks.affstrack.com/"] > img, :root a[href^="https://ak.hauchiwu.com/"], :root a[href^="https://engine.phn.doublepimp.com/"], :root a[href^="https://engine.blueistheneworanges.com/"], :root a[href^="https://drumskilxoa.click/"], :root a[href^="https://dl-protect.net/"], :root a[href^="https://rixofa.com/"], :root #ads[style^="position: absolute; z-index: 30; width: 100%; height"], :root a[href^="https://disobediencecalculatormaiden.com/"], :root a[href*=".foxqck.com/"], :root a[href^="https://ctosrd.com/"], :root a[href^="https://clixtrac.com/"], :root [href^="https://noqreport.com/"] > img, :root a[href^="https://clicks.pipaffiliates.com/"], :root app-advertisement, :root a[href^="https://getmatchedlocally.com/"], :root a[href^="https://clickins.slixa.com/"], :root a[href^="https://datewhisper.life/"], :root a[href^="https://get-link.xyz/"], :root a[href^="https://click.linksynergy.com/fs-bin/"] > img, :root a[href^="https://combodef.com/"], :root a[href^="https://click.hoolig.app/"], :root a[href^="https://click.ggpickaff.com/"], :root a[href^="https://track.totalav.com/"], :root a[href^="https://ctrdwm.com/"], :root img[src^="https://images.purevpnaffiliates.com"], :root a[href^="https://porntubemate.com/"], :root a[href^="https://clickadilla.com/"], :root a[href^="https://click.dtiserv2.com/"], :root a[href^="https://go.xlvirdr.com"], :root a[href^="http://www.iyalc.com/"], :root a[href^="https://claring-loccelkin.com/"], :root a[href^="https://bongacams2.com/track?"], :root a[href^="https://t.ajrkm1.com/"], :root [href="https://masstortfinancing.com"] img, :root a[href^="https://bongacams10.com/track?"], :root a[href^="https://www.sheetmusicplus.com/"][href*="?aff_id="], :root a[href^="https://bngpt.com/"], :root a[href^="https://black77854.com/"], :root a[href^="https://banners.livepartners.com/"], :root a[href^="https://myclick-2.com/"], :root a[href^="https://sexynearme.com/"], :root a[href^="https://baipahanoop.net/"], :root a[href^="http://revolvemockerycopper.com/"], :root a[href^="https://awptjmp.com/"], :root a[href^="https://join.sexworld3d.com/track/"], :root a[href^="https://aweptjmp.com/"], :root a[href^="https://ausoafab.net/"], :root a[href^="https://adclick.g.doubleclick.net/"], :root a[href^="https://bc.game/"], :root a[href^="https://a.bestcontentoperation.top/"], :root a[href^="https://adultfriendfinder.com/go/"], :root a[href^="https://ads.planetwin365affiliate.com/"], :root a[href^="https://ads.leovegas.com/"], :root a[href^="https://auesk.cfd/"], :root a[href^="https://a2.adform.net/"], :root a[href^="https://a.candyai.love/"], :root a[href^="https://playnano.online/offerwalls/?ref="], :root a[href^="https://a.adtng.com/"], :root .banner-img > .pbl, :root [data-m-ad-id], :root a[href^="https://a-ads.com/"], :root a[href^="https://ak.psaltauw.net/"], :root a[href^="https://1winpb.com/"], :root div[id^="rc-widget-"], :root a[href^="http://eslp34af.click/"], :root a[href^="https://turnstileunavailablesite.com/"], :root a[href^="https://chaturbate.com/in/?"], :root a[href^="https://prf.hn/click/"][href*="/creativeref:"] > img, :root a[href*="&maxads="], :root a[href^="http://www.adultempire.com/unlimited/promo?"][href*="&partner_id="], :root a[href^="https://1betandgonow.com/"], :root a[href^="https://eergortu.net/"], :root div[id^="optidigital-adslot"], :root a[href^="https://123-stream.org/"], :root a[href^="http://www.friendlyduck.com/AF_"], :root a[href^="https://allhost.shop/aff.php?"], :root [data-dynamic-ads], :root a[href^="http://vnte9urn.click/"], :root a[href^="https://getvideoz.click/"], :root a[href^="http://troopsassistedstupidity.com/"], :root a[href^="http://trk.globwo.online/"], :root a[href^="https://random-affiliate.atimaze.com/"], :root a-ad, :root a[href^="https://offhandpump.com/"], :root a[href^="http://stickingrepute.com/"], :root #slashboxes > .deals-rail, :root a[href^="http://roadcontagion.com/"], :root a[href^="http://premonitioninventdisagree.com/"], :root a[href^="http://naggingirresponsible.com/"], :root a[href^="https://in.rabbtrk.com/"], :root a[href^="http://www.h4trck.com/"], :root a[href^="https://81ac.xyz/"], :root a[href^="http://guestblackmail.com/"], :root a[href^="http://cam4com.go2cloud.org/aff_c?"], :root a[href^="https://ads.betfair.com/redirect.aspx?"], :root [href^="https://www.mypatriotsupply.com/"] > img, :root a[href^="https://trk.softonixs.xyz/"], :root a[href^="http://dragnag.com/"], :root a[href^="http://dragfault.com/"], :root [data-advadstrackid], :root a[href^="http://muzzlematrix.com/"], :root a[href^="https://track.adform.net/"], :root a[href^="http://avthelkp.net/"], :root a[href^="https://a.medfoodhome.com/"], :root a[href^="https://engine.flixtrial.com/"], :root [data-type="ad-vertical"], :root [data-taboola-options], :root a[href^="http://annulmentequitycereals.com/"], :root a[href^="//startgaming.net/tienda/" i], :root a[href^="https://www.get-express-vpn.com/offer/"], :root a[href^="https://s.cant3am.com/"], :root a[href^="//s.st1net.com/splash.php"], :root a[href^="https://join.virtualtaboo.com/track/"], :root [id^="ad_sky"], :root a[href^="http://coefficienttolerategravel.com/"], :root a[href^="https://a.medfoodsafety.com/"], :root a[href^="//go.eabids.com/"], :root a[href^="//ejitsirdosha.net/"], :root a[href^=" https://www.friendlyduck.com/AF_"], :root a[href*="/jump/next.php?r="], :root a[href^="https://go.rmishe.com/"], :root [href^="https://ilovemyfreedoms.com/landing-"], :root a[href^="https://go.nordvpn.net/aff"] > img, :root .\[\&_\.gdprAdTransparencyCogWheelButton\]\:\!pjra-z-\[5\], :root [href^="http://clicks.totemcash.com/"], :root a[href^="https://ad.zanox.com/ppc/"] > img, :root a[href^="https://lone-pack.com/"], :root [data-d-ad-id], :root a[href*=".engine.adglare.net/"], :root a[href^="https://t.ajrkm3.com/"], :root [href^="https://aads.com/campaigns/"], :root a[href^="//stighoazon.com/"], :root [href^="https://www.profitablegatecpm.com/"], :root div[id^="lazyad-"], :root a[href^="http://com-1.pro/"], :root a[href*=".cfm?domain="][href*="&fp="], :root [data-ad-name], :root a[href^="https://loboclick.com/"], :root a[data-url^="https://vulpix.bet/?ref="], :root a[href^="https://ab.advertiserurl.com/aff/"], :root a[data-oburl^="https://paid.outbrain.com/network/redir?"], :root a[href^="https://go.xlivrdr.com"], :root [onclick^="location.href='https://1337x.vpnonly.site/"], :root [name^="google_ads_iframe"], :root [id^="section-ad-banner"], :root a[href^="https://www.goldenfrog.com/vyprvpn?offer_id="][href*="&aff_id="], :root a[href*="//jjgirls.com/sex/Chaturbate"], :root [id^="ad-wrap-"], :root [href^="https://zone.gotrackier.com/"], :root a[href^="http://sarcasmadvisor.com/"], :root [href^="https://www.restoro.com/"], :root [href^="https://www.targetingpartner.com/"], :root .section-subheader > .section-hotel-prices-header, :root [href^="https://www.hostg.xyz/"] > img, :root a[href^="http://adultfriendfinder.com/go/"], :root a[href^="https://fastestvpn.com/lifetime-special-deal?a_aid="], :root a[href^="https://tour.mrskin.com/"], :root [href^="https://www.brighteonstore.com/products/"] img, :root citrus-ad-wrapper, :root a[href^="https://go.grinsbest.com/"], :root a[href^="https://vo2.qrlsx.com/"], :root [href^="https://www.avantlink.com/click.php"] img, :root [href^="https://wct.link/click?"], :root div[data-adunit], :root app-large-ad, :root [href^="https://turtlebids.irauctions.com/"] img, :root div[id^="div-ads-"], :root [href^="https://rapidgator.net/article/premium/ref/"], :root [href^="https://join.girlsoutwest.com/"], :root a[href^="https://activate-game.com/"], :root .scroll-fixable.rail-right > .deals-rail, :root [data-wpas-zoneid], :root a[href^="https://track.aftrk3.com/"], :root [href^="https://join3.bannedsextapes.com"], :root a[href^="https://bodelen.com/"], :root a[href*=".g2afse.com/"], :root div[id^="adngin-"], :root [data-rc-widget], :root span[data-ez-ph-id], :root [href^="https://track.aftrk1.com/"], :root [href^="https://join.playboyplus.com/track/"], :root a[href^="https://go.xxxijmp.com"], :root [href^="https://istlnkcl.com/"], :root a[href^="https://tm-offers.gamingadult.com/"], :root [href^="https://charmingdatings.life/"], :root [href^="https://glersakr.com/"], :root a[href^="https://a.bestcontentfood.top/"], :root [href^="https://cpa.10kfreesilver.com/"], :root [data-id^="div-gpt-ad"], :root a[href^="https://tracker.loropartners.com/"], :root [href^="https://awbbjmp.com/"], :root div[ow-ad-unit-wrapper], :root a[data-href^="http://ads.trafficjunky.net/"], :root a[href^="http://partners.etoro.com/"], :root a[href^="https://www.friendlyduck.com/AF_"], :root [href^="https://ad1.adfarm1.adition.com/"], :root a[href^="https://bngprm.com/"], :root [href^="https://shiftnetwork.infusionsoft.com/go/"] > img, :root a[href^="https://go.strpjmp.com/"], :root a[href^="https://go.bushheel.com/"], :root a[href^="https://ctjdwm.com/"], :root a[href^="https://camfapr.com/landing/click/"], :root div[data-ad-wrapper], :root .gnt_em_vp_c[data-g-s="vp_dk"], :root [href="//sexcams.plus/"], :root [href^="http://www.mypillow.com/"] > img, :root a[href^="https://promerycergerful.com/"], :root #kt_player > a[target="_blank"], :root a[href^="http://bongacams.com/track?"], :root [href^="http://mypillow.com/"] > img, :root [href="https://ourgoldguy.com/contact/"] img, :root a[href^="https://wittered-mainging.com/"], :root #teaser3[style="width: 100%;text-align: center;display: scroll;position:fixed;bottom: 0;margin: 0 auto;z-index: 103;"], :root [href="https://www.masstortfinancing.com/"] > img, :root .ob_container .item-container-obpd, :root [id^="div-gpt-ad"], :root a[href^="https://go.rmhfrtnd.com/"], :root [href="https://jdrucker.com/gold"] > img, :root .grid > .container > #aside-promotion, :root DFP-AD, :root [href^="https://go.xlrdr.com"], :root [data-testid^="taboola-"], :root a[href^="https://track.1234sd123.com/"], :root zeus-ad, :root [data-testid="prism-ad-wrapper"], :root [href^="https://ad.admitad.com/"], :root [href^="https://mypillow.com/"] > img, :root [data-testid="ad_testID"], :root [href^="https://antiagingbed.com/discount/"] > img, :root a[href*=".adsrv.eacdn.com/"], :root [href^="https://optimizedelite.com/"] > img, :root [data-name="adaptiveConstructorAd"], :root a[href^="https://go.cmtaffiliates.com/"], :root [data-testid="adBanner-wrapper"], :root [href^="https://mylead.global/stl/"] > img, :root [href^="https://mypatriotsupply.com/"] > img, :root a[href^="https://go.hpyjmp.com"], :root iframe[scrolling="no"][sandbox*="allow-popups allow-modals"][style^="width: 100%; height: 100%; border: none;"], :root [href^="https://mystore.com/"] > img, :root a[href^="https://believessway.com/"], :root a[href^="https://witnessjacket.com/"], :root [data-mobile-ad-id], :root [class^="amp-ad-"], :root a[href^="http://handgripvegetationhols.com/"], :root a[href^="https://go.bbrdbr.com"], :root a[href^="https://fc.lc/ref/"], :root [data-adshim], :root topadblock, :root a[href^="//s.zlinkd.com/"], :root #teaser1[style^="width:autopx;"], :root [href^="https://www.cloudways.com/en/?id"], :root [data-asg-ins], :root a[href^="https://gamingadlt.com/?offer="], :root [data-desktop-ad-id], :root [id^="ad_slider"], :root [data-adbridg-ad-class], :root #teaser3[style^="width:autopx;"], :root [data-adblockkey], :root [data-block-type="ad"], :root [data-ad-width], :root [onclick*="content.ad/"], :root [data-ad-manager-id], :root AMP-AD, :root [data-ad-cls], :root [data-ez-name], :root a[href^="https://go.mnaspm.com/"], :root a[href^="https://service.bv-aff-trx.com/"], :root a[href^="https://6-partner.com/"], :root [class^="s2nPlayer"], :root a[href^="https://traffdaq.com/"], :root [data-testid="commercial-label-taboola"], :root [class^="div-gpt-ad"], :root a[href^="http://tc.tradetracker.net/"] > img, :root a[href^="https://www8.smartadserver.com/"], :root a[href^="https://pb-imc.com/"], :root [href^="https://affiliate.fastcomet.com/"] > img, :root [class^="adDisplay-module"], :root [data-freestar-ad][id], :root AD-SLOT, :root a[href^="https://www.googleadservices.com/pagead/aclk?"] > img, :root [data-ad-module], :root a[href^="https://go.skinstrip.net"][href*="?campaignId="], :root #teaser2[style^="width:autopx;"], :root a[href^="https://ngineet.cfd/"], :root [data-revive-zoneid], :root a[href^="https://losingoldfry.com/"], :root div[id^="div-gpt-"], :root a[href^="https://gml-grp.com/"], :root .ob_dual_right > .ob_ads_header ~ .odb_div, :root a[href^="https://cam4com.go2cloud.org/"], :root a[href^="http://li.blogtrottr.com/click?"], :root a[onmousedown^="this.href='https://paid.outbrain.com/network/redir?"], :root a[href^="https://t.ajump1.com/"], :root a[href^="https://go.xxxjmp.com"], :root #leader-companion > a[href]
      {
        display: none !important;
      }
    </style>
    <script>
        var webgl_Detector = {

canvas: !! window.CanvasRenderingContext2D,
webgl: ( function () { try { var canvas = document.createElement( 'canvas' ); return !! window.WebGLRenderingContext && ( canvas.getContext( 'webgl' ) || canvas.getContext( 'experimental-webgl' ) ); } catch( e ) { return false; } } )(),
workers: !! window.Worker,
fileapi: window.File && window.FileReader && window.FileList && window.Blob,

getWebGLErrorMessage: function () {

        var element = document.createElement( 'div' );
        element.id = 'webgl-error-message';
        element.style.fontFamily = 'monospace';
        element.style.fontSize = '13px';
        element.style.fontWeight = 'normal';
        element.style.textAlign = 'center';
        element.style.background = '#fff';
        element.style.color = '#000';
        element.style.padding = '1.5em';
        element.style.width = '400px';
        element.style.margin = '5em auto 0';

        if ( ! this.webgl ) {

                element.innerHTML = window.WebGLRenderingContext ? [
                        'Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />',
                        'Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'
                ].join( '\n' ) : [
                        'Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>',
                        'Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'
                ].join( '\n' );

        }

        return element;

},

addGetWebGLMessage: function ( parameters ) {

        var parent, id, element;

        parameters = parameters || {};

        parent = parameters.parent !== undefined ? parameters.parent : document.body;
        id = parameters.id !== undefined ? parameters.id : 'oldie';

        element = Detector.getWebGLErrorMessage();
        element.id = id;

        parent.appendChild( element );

}

};
    </script>
    <script>
        /**
 * @author mrdoob / http://mrdoob.com/
 * @author supereggbert / http://www.paulbrunt.co.uk/
 * @author julianwa / https://github.com/julianwa
 */

THREE.RenderableObject = function () {

this.id = 0;

this.object = null;
this.z = 0;
this.renderOrder = 0;

};

//

THREE.RenderableFace = function () {

this.id = 0;

this.v1 = new THREE.RenderableVertex();
this.v2 = new THREE.RenderableVertex();
this.v3 = new THREE.RenderableVertex();

this.normalModel = new THREE.Vector3();

this.vertexNormalsModel = [ new THREE.Vector3(), new THREE.Vector3(), new THREE.Vector3() ];
this.vertexNormalsLength = 0;

this.color = new THREE.Color();
this.material = null;
this.uvs = [ new THREE.Vector2(), new THREE.Vector2(), new THREE.Vector2() ];

this.z = 0;
this.renderOrder = 0;

};

//

THREE.RenderableVertex = function () {

this.position = new THREE.Vector3();
this.positionWorld = new THREE.Vector3();
this.positionScreen = new THREE.Vector4();

this.visible = true;

};

THREE.RenderableVertex.prototype.copy = function ( vertex ) {

this.positionWorld.copy( vertex.positionWorld );
this.positionScreen.copy( vertex.positionScreen );

};

//

THREE.RenderableLine = function () {

this.id = 0;

this.v1 = new THREE.RenderableVertex();
this.v2 = new THREE.RenderableVertex();

this.vertexColors = [ new THREE.Color(), new THREE.Color() ];
this.material = null;

this.z = 0;
this.renderOrder = 0;

};

//

THREE.RenderableSprite = function () {

this.id = 0;

this.object = null;

this.x = 0;
this.y = 0;
this.z = 0;

this.rotation = 0;
this.scale = new THREE.Vector2();

this.material = null;
this.renderOrder = 0;

};

//

THREE.Projector = function () {

var _object, _objectCount, _objectPool = [], _objectPoolLength = 0,
    _vertex, _vertexCount, _vertexPool = [], _vertexPoolLength = 0,
    _face, _faceCount, _facePool = [], _facePoolLength = 0,
    _line, _lineCount, _linePool = [], _linePoolLength = 0,
    _sprite, _spriteCount, _spritePool = [], _spritePoolLength = 0,

    _renderData = { objects: [], lights: [], elements: [] },

    _vector3 = new THREE.Vector3(),
    _vector4 = new THREE.Vector4(),

    _clipBox = new THREE.Box3( new THREE.Vector3( - 1, - 1, - 1 ), new THREE.Vector3( 1, 1, 1 ) ),
    _boundingBox = new THREE.Box3(),
    _points3 = new Array( 3 ),

    _viewMatrix = new THREE.Matrix4(),
    _viewProjectionMatrix = new THREE.Matrix4(),

    _modelMatrix,
    _modelViewProjectionMatrix = new THREE.Matrix4(),

    _normalMatrix = new THREE.Matrix3(),

    _frustum = new THREE.Frustum(),

    _clippedVertex1PositionScreen = new THREE.Vector4(),
    _clippedVertex2PositionScreen = new THREE.Vector4();

//

this.projectVector = function ( vector, camera ) {

    console.warn( 'THREE.Projector: .projectVector() is now vector.project().' );
    vector.project( camera );

};

this.unprojectVector = function ( vector, camera ) {

    console.warn( 'THREE.Projector: .unprojectVector() is now vector.unproject().' );
    vector.unproject( camera );

};

this.pickingRay = function () {

    console.error( 'THREE.Projector: .pickingRay() is now raycaster.setFromCamera().' );

};

//

var RenderList = function () {

    var normals = [];
    var colors = [];
    var uvs = [];

    var object = null;
    var material = null;

    var normalMatrix = new THREE.Matrix3();

    function setObject( value ) {

        object = value;
        material = object.material;

        normalMatrix.getNormalMatrix( object.matrixWorld );

        normals.length = 0;
        colors.length = 0;
        uvs.length = 0;

    }

    function projectVertex( vertex ) {

        var position = vertex.position;
        var positionWorld = vertex.positionWorld;
        var positionScreen = vertex.positionScreen;

        positionWorld.copy( position ).applyMatrix4( _modelMatrix );
        positionScreen.copy( positionWorld ).applyMatrix4( _viewProjectionMatrix );

        var invW = 1 / positionScreen.w;

        positionScreen.x *= invW;
        positionScreen.y *= invW;
        positionScreen.z *= invW;

        vertex.visible = positionScreen.x >= - 1 && positionScreen.x <= 1 &&
                 positionScreen.y >= - 1 && positionScreen.y <= 1 &&
                 positionScreen.z >= - 1 && positionScreen.z <= 1;

    }

    function pushVertex( x, y, z ) {

        _vertex = getNextVertexInPool();
        _vertex.position.set( x, y, z );

        projectVertex( _vertex );

    }

    function pushNormal( x, y, z ) {

        normals.push( x, y, z );

    }

    function pushColor( r, g, b ) {

        colors.push( r, g, b );

    }

    function pushUv( x, y ) {

        uvs.push( x, y );

    }

    function checkTriangleVisibility( v1, v2, v3 ) {

        if ( v1.visible === true || v2.visible === true || v3.visible === true ) return true;

        _points3[ 0 ] = v1.positionScreen;
        _points3[ 1 ] = v2.positionScreen;
        _points3[ 2 ] = v3.positionScreen;

        return _clipBox.intersectsBox( _boundingBox.setFromPoints( _points3 ) );

    }

    function checkBackfaceCulling( v1, v2, v3 ) {

        return ( ( v3.positionScreen.x - v1.positionScreen.x ) *
                ( v2.positionScreen.y - v1.positionScreen.y ) -
                ( v3.positionScreen.y - v1.positionScreen.y ) *
                ( v2.positionScreen.x - v1.positionScreen.x ) ) < 0;

    }

    function pushLine( a, b ) {

        var v1 = _vertexPool[ a ];
        var v2 = _vertexPool[ b ];

        // Clip

        v1.positionScreen.copy( v1.position ).applyMatrix4( _modelViewProjectionMatrix );
        v2.positionScreen.copy( v2.position ).applyMatrix4( _modelViewProjectionMatrix );

        if ( clipLine( v1.positionScreen, v2.positionScreen ) === true ) {

            // Perform the perspective divide
            v1.positionScreen.multiplyScalar( 1 / v1.positionScreen.w );
            v2.positionScreen.multiplyScalar( 1 / v2.positionScreen.w );

            _line = getNextLineInPool();
            _line.id = object.id;
            _line.v1.copy( v1 );
            _line.v2.copy( v2 );
            _line.z = Math.max( v1.positionScreen.z, v2.positionScreen.z );
            _line.renderOrder = object.renderOrder;

            _line.material = object.material;

            if ( object.material.vertexColors === THREE.VertexColors ) {

                _line.vertexColors[ 0 ].fromArray( colors, a * 3 );
                _line.vertexColors[ 1 ].fromArray( colors, b * 3 );

            }

            _renderData.elements.push( _line );

        }

    }

    function pushTriangle( a, b, c ) {

        var v1 = _vertexPool[ a ];
        var v2 = _vertexPool[ b ];
        var v3 = _vertexPool[ c ];

        if ( checkTriangleVisibility( v1, v2, v3 ) === false ) return;

        if ( material.side === THREE.DoubleSide || checkBackfaceCulling( v1, v2, v3 ) === true ) {

            _face = getNextFaceInPool();

            _face.id = object.id;
            _face.v1.copy( v1 );
            _face.v2.copy( v2 );
            _face.v3.copy( v3 );
            _face.z = ( v1.positionScreen.z + v2.positionScreen.z + v3.positionScreen.z ) / 3;
            _face.renderOrder = object.renderOrder;

            // use first vertex normal as face normal

            _face.normalModel.fromArray( normals, a * 3 );
            _face.normalModel.applyMatrix3( normalMatrix ).normalize();

            for ( var i = 0; i < 3; i ++ ) {

                var normal = _face.vertexNormalsModel[ i ];
                normal.fromArray( normals, arguments[ i ] * 3 );
                normal.applyMatrix3( normalMatrix ).normalize();

                var uv = _face.uvs[ i ];
                uv.fromArray( uvs, arguments[ i ] * 2 );

            }

            _face.vertexNormalsLength = 3;

            _face.material = object.material;

            _renderData.elements.push( _face );

        }

    }

    return {
        setObject: setObject,
        projectVertex: projectVertex,
        checkTriangleVisibility: checkTriangleVisibility,
        checkBackfaceCulling: checkBackfaceCulling,
        pushVertex: pushVertex,
        pushNormal: pushNormal,
        pushColor: pushColor,
        pushUv: pushUv,
        pushLine: pushLine,
        pushTriangle: pushTriangle
    };

};

var renderList = new RenderList();

function projectObject( object ) {

    if ( object.visible === false ) return;

    if ( object instanceof THREE.Light ) {

        _renderData.lights.push( object );

    } else if ( object instanceof THREE.Mesh || object instanceof THREE.Line || object instanceof THREE.Points ) {

        if ( object.material.visible === false ) return;
        if ( object.frustumCulled === true && _frustum.intersectsObject( object ) === false ) return;

        addObject( object );

    } else if ( object instanceof THREE.Sprite ) {

        if ( object.material.visible === false ) return;
        if ( object.frustumCulled === true && _frustum.intersectsSprite( object ) === false ) return;

        addObject( object );

    }

    var children = object.children;

    for ( var i = 0, l = children.length; i < l; i ++ ) {

        projectObject( children[ i ] );

    }

}

function addObject( object ) {

    _object = getNextObjectInPool();
    _object.id = object.id;
    _object.object = object;

    _vector3.setFromMatrixPosition( object.matrixWorld );
    _vector3.applyMatrix4( _viewProjectionMatrix );
    _object.z = _vector3.z;
    _object.renderOrder = object.renderOrder;

    _renderData.objects.push( _object );

}

this.projectScene = function ( scene, camera, sortObjects, sortElements ) {

    _faceCount = 0;
    _lineCount = 0;
    _spriteCount = 0;

    _renderData.elements.length = 0;

    if ( scene.autoUpdate === true ) scene.updateMatrixWorld();
    if ( camera.parent === null ) camera.updateMatrixWorld();

    _viewMatrix.copy( camera.matrixWorldInverse );
    _viewProjectionMatrix.multiplyMatrices( camera.projectionMatrix, _viewMatrix );

    _frustum.setFromMatrix( _viewProjectionMatrix );

    //

    _objectCount = 0;

    _renderData.objects.length = 0;
    _renderData.lights.length = 0;

    projectObject( scene );

    if ( sortObjects === true ) {

        _renderData.objects.sort( painterSort );

    }

    //

    var objects = _renderData.objects;

    for ( var o = 0, ol = objects.length; o < ol; o ++ ) {

        var object = objects[ o ].object;
        var geometry = object.geometry;

        renderList.setObject( object );

        _modelMatrix = object.matrixWorld;

        _vertexCount = 0;

        if ( object instanceof THREE.Mesh ) {

            if ( geometry instanceof THREE.BufferGeometry ) {

                var attributes = geometry.attributes;
                var groups = geometry.groups;

                if ( attributes.position === undefined ) continue;

                var positions = attributes.position.array;

                for ( var i = 0, l = positions.length; i < l; i += 3 ) {

                    renderList.pushVertex( positions[ i ], positions[ i + 1 ], positions[ i + 2 ] );

                }

                if ( attributes.normal !== undefined ) {

                    var normals = attributes.normal.array;

                    for ( var i = 0, l = normals.length; i < l; i += 3 ) {

                        renderList.pushNormal( normals[ i ], normals[ i + 1 ], normals[ i + 2 ] );

                    }

                }

                if ( attributes.uv !== undefined ) {

                    var uvs = attributes.uv.array;

                    for ( var i = 0, l = uvs.length; i < l; i += 2 ) {

                        renderList.pushUv( uvs[ i ], uvs[ i + 1 ] );

                    }

                }

                if ( geometry.index !== null ) {

                    var indices = geometry.index.array;

                    if ( groups.length > 0 ) {

                        for ( var g = 0; g < groups.length; g ++ ) {

                            var group = groups[ g ];

                            for ( var i = group.start, l = group.start + group.count; i < l; i += 3 ) {

                                renderList.pushTriangle( indices[ i ], indices[ i + 1 ], indices[ i + 2 ] );

                            }

                        }

                    } else {

                        for ( var i = 0, l = indices.length; i < l; i += 3 ) {

                            renderList.pushTriangle( indices[ i ], indices[ i + 1 ], indices[ i + 2 ] );

                        }

                    }

                } else {

                    for ( var i = 0, l = positions.length / 3; i < l; i += 3 ) {

                        renderList.pushTriangle( i, i + 1, i + 2 );

                    }

                }

            } else if ( geometry instanceof THREE.Geometry ) {

                var vertices = geometry.vertices;
                var faces = geometry.faces;
                var faceVertexUvs = geometry.faceVertexUvs[ 0 ];

                _normalMatrix.getNormalMatrix( _modelMatrix );

                var material = object.material;

                var isMultiMaterial = Array.isArray( material );

                for ( var v = 0, vl = vertices.length; v < vl; v ++ ) {

                    var vertex = vertices[ v ];

                    _vector3.copy( vertex );

                    if ( material.morphTargets === true ) {

                        var morphTargets = geometry.morphTargets;
                        var morphInfluences = object.morphTargetInfluences;

                        for ( var t = 0, tl = morphTargets.length; t < tl; t ++ ) {

                            var influence = morphInfluences[ t ];

                            if ( influence === 0 ) continue;

                            var target = morphTargets[ t ];
                            var targetVertex = target.vertices[ v ];

                            _vector3.x += ( targetVertex.x - vertex.x ) * influence;
                            _vector3.y += ( targetVertex.y - vertex.y ) * influence;
                            _vector3.z += ( targetVertex.z - vertex.z ) * influence;

                        }

                    }

                    renderList.pushVertex( _vector3.x, _vector3.y, _vector3.z );

                }

                for ( var f = 0, fl = faces.length; f < fl; f ++ ) {

                    var face = faces[ f ];

                    material = isMultiMaterial === true
                         ? object.material[ face.materialIndex ]
                         : object.material;

                    if ( material === undefined ) continue;

                    var side = material.side;

                    var v1 = _vertexPool[ face.a ];
                    var v2 = _vertexPool[ face.b ];
                    var v3 = _vertexPool[ face.c ];

                    if ( renderList.checkTriangleVisibility( v1, v2, v3 ) === false ) continue;

                    var visible = renderList.checkBackfaceCulling( v1, v2, v3 );

                    if ( side !== THREE.DoubleSide ) {

                        if ( side === THREE.FrontSide && visible === false ) continue;
                        if ( side === THREE.BackSide && visible === true ) continue;

                    }

                    _face = getNextFaceInPool();

                    _face.id = object.id;
                    _face.v1.copy( v1 );
                    _face.v2.copy( v2 );
                    _face.v3.copy( v3 );

                    _face.normalModel.copy( face.normal );

                    if ( visible === false && ( side === THREE.BackSide || side === THREE.DoubleSide ) ) {

                        _face.normalModel.negate();

                    }

                    _face.normalModel.applyMatrix3( _normalMatrix ).normalize();

                    var faceVertexNormals = face.vertexNormals;

                    for ( var n = 0, nl = Math.min( faceVertexNormals.length, 3 ); n < nl; n ++ ) {

                        var normalModel = _face.vertexNormalsModel[ n ];
                        normalModel.copy( faceVertexNormals[ n ] );

                        if ( visible === false && ( side === THREE.BackSide || side === THREE.DoubleSide ) ) {

                            normalModel.negate();

                        }

                        normalModel.applyMatrix3( _normalMatrix ).normalize();

                    }

                    _face.vertexNormalsLength = faceVertexNormals.length;

                    var vertexUvs = faceVertexUvs[ f ];

                    if ( vertexUvs !== undefined ) {

                        for ( var u = 0; u < 3; u ++ ) {

                            _face.uvs[ u ].copy( vertexUvs[ u ] );

                        }

                    }

                    _face.color = face.color;
                    _face.material = material;

                    _face.z = ( v1.positionScreen.z + v2.positionScreen.z + v3.positionScreen.z ) / 3;
                    _face.renderOrder = object.renderOrder;

                    _renderData.elements.push( _face );

                }

            }

        } else if ( object instanceof THREE.Line ) {

            _modelViewProjectionMatrix.multiplyMatrices( _viewProjectionMatrix, _modelMatrix );

            if ( geometry instanceof THREE.BufferGeometry ) {

                var attributes = geometry.attributes;

                if ( attributes.position !== undefined ) {

                    var positions = attributes.position.array;

                    for ( var i = 0, l = positions.length; i < l; i += 3 ) {

                        renderList.pushVertex( positions[ i ], positions[ i + 1 ], positions[ i + 2 ] );

                    }

                    if ( attributes.color !== undefined ) {

                        var colors = attributes.color.array;

                        for ( var i = 0, l = colors.length; i < l; i += 3 ) {

                            renderList.pushColor( colors[ i ], colors[ i + 1 ], colors[ i + 2 ] );

                        }

                    }

                    if ( geometry.index !== null ) {

                        var indices = geometry.index.array;

                        for ( var i = 0, l = indices.length; i < l; i += 2 ) {

                            renderList.pushLine( indices[ i ], indices[ i + 1 ] );

                        }

                    } else {

                        var step = object instanceof THREE.LineSegments ? 2 : 1;

                        for ( var i = 0, l = ( positions.length / 3 ) - 1; i < l; i += step ) {

                            renderList.pushLine( i, i + 1 );

                        }

                    }

                }

            } else if ( geometry instanceof THREE.Geometry ) {

                var vertices = object.geometry.vertices;

                if ( vertices.length === 0 ) continue;

                v1 = getNextVertexInPool();
                v1.positionScreen.copy( vertices[ 0 ] ).applyMatrix4( _modelViewProjectionMatrix );

                var step = object instanceof THREE.LineSegments ? 2 : 1;

                for ( var v = 1, vl = vertices.length; v < vl; v ++ ) {

                    v1 = getNextVertexInPool();
                    v1.positionScreen.copy( vertices[ v ] ).applyMatrix4( _modelViewProjectionMatrix );

                    if ( ( v + 1 ) % step > 0 ) continue;

                    v2 = _vertexPool[ _vertexCount - 2 ];

                    _clippedVertex1PositionScreen.copy( v1.positionScreen );
                    _clippedVertex2PositionScreen.copy( v2.positionScreen );

                    if ( clipLine( _clippedVertex1PositionScreen, _clippedVertex2PositionScreen ) === true ) {

                        // Perform the perspective divide
                        _clippedVertex1PositionScreen.multiplyScalar( 1 / _clippedVertex1PositionScreen.w );
                        _clippedVertex2PositionScreen.multiplyScalar( 1 / _clippedVertex2PositionScreen.w );

                        _line = getNextLineInPool();

                        _line.id = object.id;
                        _line.v1.positionScreen.copy( _clippedVertex1PositionScreen );
                        _line.v2.positionScreen.copy( _clippedVertex2PositionScreen );

                        _line.z = Math.max( _clippedVertex1PositionScreen.z, _clippedVertex2PositionScreen.z );
                        _line.renderOrder = object.renderOrder;

                        _line.material = object.material;

                        if ( object.material.vertexColors === THREE.VertexColors ) {

                            _line.vertexColors[ 0 ].copy( object.geometry.colors[ v ] );
                            _line.vertexColors[ 1 ].copy( object.geometry.colors[ v - 1 ] );

                        }

                        _renderData.elements.push( _line );

                    }

                }

            }

        } else if ( object instanceof THREE.Points ) {

            _modelViewProjectionMatrix.multiplyMatrices( _viewProjectionMatrix, _modelMatrix );

            if ( geometry instanceof THREE.Geometry ) {

                var vertices = object.geometry.vertices;

                for ( var v = 0, vl = vertices.length; v < vl; v ++ ) {

                    var vertex = vertices[ v ];

                    _vector4.set( vertex.x, vertex.y, vertex.z, 1 );
                    _vector4.applyMatrix4( _modelViewProjectionMatrix );

                    pushPoint( _vector4, object, camera );

                }

            } else if ( geometry instanceof THREE.BufferGeometry ) {

                var attributes = geometry.attributes;

                if ( attributes.position !== undefined ) {

                    var positions = attributes.position.array;

                    for ( var i = 0, l = positions.length; i < l; i += 3 ) {

                        _vector4.set( positions[ i ], positions[ i + 1 ], positions[ i + 2 ], 1 );
                        _vector4.applyMatrix4( _modelViewProjectionMatrix );

                        pushPoint( _vector4, object, camera );

                    }

                }

            }

        } else if ( object instanceof THREE.Sprite ) {

            _vector4.set( _modelMatrix.elements[ 12 ], _modelMatrix.elements[ 13 ], _modelMatrix.elements[ 14 ], 1 );
            _vector4.applyMatrix4( _viewProjectionMatrix );

            pushPoint( _vector4, object, camera );

        }

    }

    if ( sortElements === true ) {

        _renderData.elements.sort( painterSort );

    }

    return _renderData;

};

function pushPoint( _vector4, object, camera ) {

    var invW = 1 / _vector4.w;

    _vector4.z *= invW;

    if ( _vector4.z >= - 1 && _vector4.z <= 1 ) {

        _sprite = getNextSpriteInPool();
        _sprite.id = object.id;
        _sprite.x = _vector4.x * invW;
        _sprite.y = _vector4.y * invW;
        _sprite.z = _vector4.z;
        _sprite.renderOrder = object.renderOrder;
        _sprite.object = object;

        _sprite.rotation = object.rotation;

        _sprite.scale.x = object.scale.x * Math.abs( _sprite.x - ( _vector4.x + camera.projectionMatrix.elements[ 0 ] ) / ( _vector4.w + camera.projectionMatrix.elements[ 12 ] ) );
        _sprite.scale.y = object.scale.y * Math.abs( _sprite.y - ( _vector4.y + camera.projectionMatrix.elements[ 5 ] ) / ( _vector4.w + camera.projectionMatrix.elements[ 13 ] ) );

        _sprite.material = object.material;

        _renderData.elements.push( _sprite );

    }

}

// Pools

function getNextObjectInPool() {

    if ( _objectCount === _objectPoolLength ) {

        var object = new THREE.RenderableObject();
        _objectPool.push( object );
        _objectPoolLength ++;
        _objectCount ++;
        return object;

    }

    return _objectPool[ _objectCount ++ ];

}

function getNextVertexInPool() {

    if ( _vertexCount === _vertexPoolLength ) {

        var vertex = new THREE.RenderableVertex();
        _vertexPool.push( vertex );
        _vertexPoolLength ++;
        _vertexCount ++;
        return vertex;

    }

    return _vertexPool[ _vertexCount ++ ];

}

function getNextFaceInPool() {

    if ( _faceCount === _facePoolLength ) {

        var face = new THREE.RenderableFace();
        _facePool.push( face );
        _facePoolLength ++;
        _faceCount ++;
        return face;

    }

    return _facePool[ _faceCount ++ ];


}

function getNextLineInPool() {

    if ( _lineCount === _linePoolLength ) {

        var line = new THREE.RenderableLine();
        _linePool.push( line );
        _linePoolLength ++;
        _lineCount ++;
        return line;

    }

    return _linePool[ _lineCount ++ ];

}

function getNextSpriteInPool() {

    if ( _spriteCount === _spritePoolLength ) {

        var sprite = new THREE.RenderableSprite();
        _spritePool.push( sprite );
        _spritePoolLength ++;
        _spriteCount ++;
        return sprite;

    }

    return _spritePool[ _spriteCount ++ ];

}

//

function painterSort( a, b ) {

    if ( a.renderOrder !== b.renderOrder ) {

        return a.renderOrder - b.renderOrder;

    } else if ( a.z !== b.z ) {

        return b.z - a.z;

    } else if ( a.id !== b.id ) {

        return a.id - b.id;

    } else {

        return 0;

    }

}

function clipLine( s1, s2 ) {

    var alpha1 = 0, alpha2 = 1,

    // Calculate the boundary coordinate of each vertex for the near and far clip planes,
    // Z = -1 and Z = +1, respectively.

        bc1near = s1.z + s1.w,
        bc2near = s2.z + s2.w,
        bc1far = - s1.z + s1.w,
        bc2far = - s2.z + s2.w;

    if ( bc1near >= 0 && bc2near >= 0 && bc1far >= 0 && bc2far >= 0 ) {

        // Both vertices lie entirely within all clip planes.
        return true;

    } else if ( ( bc1near < 0 && bc2near < 0 ) || ( bc1far < 0 && bc2far < 0 ) ) {

        // Both vertices lie entirely outside one of the clip planes.
        return false;

    } else {

        // The line segment spans at least one clip plane.

        if ( bc1near < 0 ) {

            // v1 lies outside the near plane, v2 inside
            alpha1 = Math.max( alpha1, bc1near / ( bc1near - bc2near ) );

        } else if ( bc2near < 0 ) {

            // v2 lies outside the near plane, v1 inside
            alpha2 = Math.min( alpha2, bc1near / ( bc1near - bc2near ) );

        }

        if ( bc1far < 0 ) {

            // v1 lies outside the far plane, v2 inside
            alpha1 = Math.max( alpha1, bc1far / ( bc1far - bc2far ) );

        } else if ( bc2far < 0 ) {

            // v2 lies outside the far plane, v2 inside
            alpha2 = Math.min( alpha2, bc1far / ( bc1far - bc2far ) );

        }

        if ( alpha2 < alpha1 ) {

            // The line segment spans two boundaries, but is outside both of them.
            // (This can't happen when we're only clipping against just near/far but good
            //  to leave the check here for future usage if other clip planes are added.)
            return false;

        } else {

            // Update the s1 and s2 vertices to match the clipped line segment.
            s1.lerp( s2, alpha1 );
            s2.lerp( s1, 1 - alpha2 );

            return true;

        }

    }

}

};
    </script>
    <script>
        /**
 * @author mrdoob / http://mrdoob.com/
 */

THREE.SpriteCanvasMaterial = function ( parameters ) {

THREE.Material.call( this );

this.type = 'SpriteCanvasMaterial';

this.color = new THREE.Color( 0xffffff );
this.program = function () {};

this.setValues( parameters );

};

THREE.SpriteCanvasMaterial.prototype = Object.create( THREE.Material.prototype );
THREE.SpriteCanvasMaterial.prototype.constructor = THREE.SpriteCanvasMaterial;
THREE.SpriteCanvasMaterial.prototype.isSpriteCanvasMaterial = true;

THREE.SpriteCanvasMaterial.prototype.clone = function () {

var material = new THREE.SpriteCanvasMaterial();

material.copy( this );
material.color.copy( this.color );
material.program = this.program;

return material;

};

//

THREE.CanvasRenderer = function ( parameters ) {

console.log( 'THREE.CanvasRenderer', THREE.REVISION );

parameters = parameters || {};

var _this = this,
    _renderData, _elements, _lights,
    _projector = new THREE.Projector(),

    _canvas = parameters.canvas !== undefined
             ? parameters.canvas
             : document.createElement( 'canvas' ),

    _canvasWidth = _canvas.width,
    _canvasHeight = _canvas.height,
    _canvasWidthHalf = Math.floor( _canvasWidth / 2 ),
    _canvasHeightHalf = Math.floor( _canvasHeight / 2 ),

    _viewportX = 0,
    _viewportY = 0,
    _viewportWidth = _canvasWidth,
    _viewportHeight = _canvasHeight,

    _pixelRatio = 1,

    _context = _canvas.getContext( '2d', {
        alpha: parameters.alpha === true
    } ),

    _clearColor = new THREE.Color( 0x000000 ),
    _clearAlpha = parameters.alpha === true ? 0 : 1,

    _contextGlobalAlpha = 1,
    _contextGlobalCompositeOperation = 0,
    _contextStrokeStyle = null,
    _contextFillStyle = null,
    _contextLineWidth = null,
    _contextLineCap = null,
    _contextLineJoin = null,
    _contextLineDash = [],

    _v1, _v2, _v3,

    _v1x, _v1y, _v2x, _v2y, _v3x, _v3y,

    _color = new THREE.Color(),

    _diffuseColor = new THREE.Color(),
    _emissiveColor = new THREE.Color(),

    _lightColor = new THREE.Color(),

    _patterns = {},

    _uvs,
    _uv1x, _uv1y, _uv2x, _uv2y, _uv3x, _uv3y,

    _clipBox = new THREE.Box2(),
    _clearBox = new THREE.Box2(),
    _elemBox = new THREE.Box2(),

    _ambientLight = new THREE.Color(),
    _directionalLights = new THREE.Color(),
    _pointLights = new THREE.Color(),

    _vector3 = new THREE.Vector3(), // Needed for PointLight
    _centroid = new THREE.Vector3(),
    _normal = new THREE.Vector3(),
    _normalViewMatrix = new THREE.Matrix3();

/* TODO
_canvas.mozImageSmoothingEnabled = false;
_canvas.webkitImageSmoothingEnabled = false;
_canvas.msImageSmoothingEnabled = false;
_canvas.imageSmoothingEnabled = false;
*/

// dash+gap fallbacks for Firefox and everything else

if ( _context.setLineDash === undefined ) {

    _context.setLineDash = function () {};

}

this.domElement = _canvas;

this.autoClear = true;
this.sortObjects = true;
this.sortElements = true;

this.info = {

    render: {

        vertices: 0,
        faces: 0

    }

};

// WebGLRenderer compatibility

this.supportsVertexTextures = function () {};
this.setFaceCulling = function () {};

// API

this.getContext = function () {

    return _context;

};

this.getContextAttributes = function () {

    return _context.getContextAttributes();

};

this.getPixelRatio = function () {

    return _pixelRatio;

};

this.setPixelRatio = function ( value ) {

    if ( value !== undefined ) _pixelRatio = value;

};

this.setSize = function ( width, height, updateStyle ) {

    _canvasWidth = width * _pixelRatio;
    _canvasHeight = height * _pixelRatio;

    _canvas.width = _canvasWidth;
    _canvas.height = _canvasHeight;

    _canvasWidthHalf = Math.floor( _canvasWidth / 2 );
    _canvasHeightHalf = Math.floor( _canvasHeight / 2 );

    if ( updateStyle !== false ) {

        _canvas.style.width = width + 'px';
        _canvas.style.height = height + 'px';

    }

    _clipBox.min.set( - _canvasWidthHalf, - _canvasHeightHalf );
    _clipBox.max.set(   _canvasWidthHalf,   _canvasHeightHalf );

    _clearBox.min.set( - _canvasWidthHalf, - _canvasHeightHalf );
    _clearBox.max.set(   _canvasWidthHalf,   _canvasHeightHalf );

    _contextGlobalAlpha = 1;
    _contextGlobalCompositeOperation = 0;
    _contextStrokeStyle = null;
    _contextFillStyle = null;
    _contextLineWidth = null;
    _contextLineCap = null;
    _contextLineJoin = null;

    this.setViewport( 0, 0, width, height );

};

this.setViewport = function ( x, y, width, height ) {

    _viewportX = x * _pixelRatio;
    _viewportY = y * _pixelRatio;

    _viewportWidth = width * _pixelRatio;
    _viewportHeight = height * _pixelRatio;

};

this.setScissor = function () {};
this.setScissorTest = function () {};

this.setClearColor = function ( color, alpha ) {

    _clearColor.set( color );
    _clearAlpha = alpha !== undefined ? alpha : 1;

    _clearBox.min.set( - _canvasWidthHalf, - _canvasHeightHalf );
    _clearBox.max.set(   _canvasWidthHalf,   _canvasHeightHalf );

};

this.setClearColorHex = function ( hex, alpha ) {

    console.warn( 'THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead.' );
    this.setClearColor( hex, alpha );

};

this.getClearColor = function () {

    return _clearColor;

};

this.getClearAlpha = function () {

    return _clearAlpha;

};

this.getMaxAnisotropy = function () {

    return 0;

};

this.clear = function () {

    if ( _clearBox.isEmpty() === false ) {

        _clearBox.intersect( _clipBox );
        _clearBox.expandByScalar( 2 );

        _clearBox.min.x =   _clearBox.min.x + _canvasWidthHalf;
        _clearBox.min.y = - _clearBox.min.y + _canvasHeightHalf;		// higher y value !
        _clearBox.max.x =   _clearBox.max.x + _canvasWidthHalf;
        _clearBox.max.y = - _clearBox.max.y + _canvasHeightHalf;		// lower y value !

        if ( _clearAlpha < 1 ) {

            _context.clearRect(
                _clearBox.min.x | 0,
                _clearBox.max.y | 0,
                ( _clearBox.max.x - _clearBox.min.x ) | 0,
                ( _clearBox.min.y - _clearBox.max.y ) | 0
            );

        }

        if ( _clearAlpha > 0 ) {

            setOpacity( 1 );
            setBlending( THREE.NormalBlending );

            setFillStyle( 'rgba(' + Math.floor( _clearColor.r * 255 ) + ',' + Math.floor( _clearColor.g * 255 ) + ',' + Math.floor( _clearColor.b * 255 ) + ',' + _clearAlpha + ')' );

            _context.fillRect(
                _clearBox.min.x | 0,
                _clearBox.max.y | 0,
                ( _clearBox.max.x - _clearBox.min.x ) | 0,
                ( _clearBox.min.y - _clearBox.max.y ) | 0
            );

        }

        _clearBox.makeEmpty();

    }

};

// compatibility

this.clearColor = function () {};
this.clearDepth = function () {};
this.clearStencil = function () {};

this.render = function ( scene, camera ) {

    if ( camera.isCamera === undefined ) {

        console.error( 'THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.' );
        return;

    }

    var background = scene.background;

    if ( background && background.isColor ) {

        setOpacity( 1 );
        setBlending( THREE.NormalBlending );

        setFillStyle( background.getStyle() );
        _context.fillRect( 0, 0, _canvasWidth, _canvasHeight );

    } else if ( this.autoClear === true ) {

        this.clear();

    }

    _this.info.render.vertices = 0;
    _this.info.render.faces = 0;

    _context.setTransform( _viewportWidth / _canvasWidth, 0, 0, - _viewportHeight / _canvasHeight, _viewportX, _canvasHeight - _viewportY );
    _context.translate( _canvasWidthHalf, _canvasHeightHalf );

    _renderData = _projector.projectScene( scene, camera, this.sortObjects, this.sortElements );
    _elements = _renderData.elements;
    _lights = _renderData.lights;

    _normalViewMatrix.getNormalMatrix( camera.matrixWorldInverse );

    /* DEBUG
    setFillStyle( 'rgba( 0, 255, 255, 0.5 )' );
    _context.fillRect( _clipBox.min.x, _clipBox.min.y, _clipBox.max.x - _clipBox.min.x, _clipBox.max.y - _clipBox.min.y );
    */

    calculateLights();

    for ( var e = 0, el = _elements.length; e < el; e ++ ) {

        var element = _elements[ e ];

        var material = element.material;

        if ( material === undefined || material.opacity === 0 ) continue;

        _elemBox.makeEmpty();

        if ( element instanceof THREE.RenderableSprite ) {

            _v1 = element;
            _v1.x *= _canvasWidthHalf; _v1.y *= _canvasHeightHalf;

            renderSprite( _v1, element, material );

        } else if ( element instanceof THREE.RenderableLine ) {

            _v1 = element.v1; _v2 = element.v2;

            _v1.positionScreen.x *= _canvasWidthHalf; _v1.positionScreen.y *= _canvasHeightHalf;
            _v2.positionScreen.x *= _canvasWidthHalf; _v2.positionScreen.y *= _canvasHeightHalf;

            _elemBox.setFromPoints( [
                _v1.positionScreen,
                _v2.positionScreen
            ] );

            if ( _clipBox.intersectsBox( _elemBox ) === true ) {

                renderLine( _v1, _v2, element, material );

            }

        } else if ( element instanceof THREE.RenderableFace ) {

            _v1 = element.v1; _v2 = element.v2; _v3 = element.v3;

            if ( _v1.positionScreen.z < - 1 || _v1.positionScreen.z > 1 ) continue;
            if ( _v2.positionScreen.z < - 1 || _v2.positionScreen.z > 1 ) continue;
            if ( _v3.positionScreen.z < - 1 || _v3.positionScreen.z > 1 ) continue;

            _v1.positionScreen.x *= _canvasWidthHalf; _v1.positionScreen.y *= _canvasHeightHalf;
            _v2.positionScreen.x *= _canvasWidthHalf; _v2.positionScreen.y *= _canvasHeightHalf;
            _v3.positionScreen.x *= _canvasWidthHalf; _v3.positionScreen.y *= _canvasHeightHalf;

            if ( material.overdraw > 0 ) {

                expand( _v1.positionScreen, _v2.positionScreen, material.overdraw );
                expand( _v2.positionScreen, _v3.positionScreen, material.overdraw );
                expand( _v3.positionScreen, _v1.positionScreen, material.overdraw );

            }

            _elemBox.setFromPoints( [
                _v1.positionScreen,
                _v2.positionScreen,
                _v3.positionScreen
            ] );

            if ( _clipBox.intersectsBox( _elemBox ) === true ) {

                renderFace3( _v1, _v2, _v3, 0, 1, 2, element, material );

            }

        }

        /* DEBUG
        setLineWidth( 1 );
        setStrokeStyle( 'rgba( 0, 255, 0, 0.5 )' );
        _context.strokeRect( _elemBox.min.x, _elemBox.min.y, _elemBox.max.x - _elemBox.min.x, _elemBox.max.y - _elemBox.min.y );
        */

        _clearBox.union( _elemBox );

    }

    /* DEBUG
    setLineWidth( 1 );
    setStrokeStyle( 'rgba( 255, 0, 0, 0.5 )' );
    _context.strokeRect( _clearBox.min.x, _clearBox.min.y, _clearBox.max.x - _clearBox.min.x, _clearBox.max.y - _clearBox.min.y );
    */

    _context.setTransform( 1, 0, 0, 1, 0, 0 );

};

//

function calculateLights() {

    _ambientLight.setRGB( 0, 0, 0 );
    _directionalLights.setRGB( 0, 0, 0 );
    _pointLights.setRGB( 0, 0, 0 );

    for ( var l = 0, ll = _lights.length; l < ll; l ++ ) {

        var light = _lights[ l ];
        var lightColor = light.color;

        if ( light.isAmbientLight ) {

            _ambientLight.add( lightColor );

        } else if ( light.isDirectionalLight ) {

            // for sprites

            _directionalLights.add( lightColor );

        } else if ( light.isPointLight ) {

            // for sprites

            _pointLights.add( lightColor );

        }

    }

}

function calculateLight( position, normal, color ) {

    for ( var l = 0, ll = _lights.length; l < ll; l ++ ) {

        var light = _lights[ l ];

        _lightColor.copy( light.color );

        if ( light.isDirectionalLight ) {

            var lightPosition = _vector3.setFromMatrixPosition( light.matrixWorld ).normalize();

            var amount = normal.dot( lightPosition );

            if ( amount <= 0 ) continue;

            amount *= light.intensity;

            color.add( _lightColor.multiplyScalar( amount ) );

        } else if ( light.isPointLight ) {

            var lightPosition = _vector3.setFromMatrixPosition( light.matrixWorld );

            var amount = normal.dot( _vector3.subVectors( lightPosition, position ).normalize() );

            if ( amount <= 0 ) continue;

            amount *= light.distance == 0 ? 1 : 1 - Math.min( position.distanceTo( lightPosition ) / light.distance, 1 );

            if ( amount == 0 ) continue;

            amount *= light.intensity;

            color.add( _lightColor.multiplyScalar( amount ) );

        }

    }

}

function renderSprite( v1, element, material ) {

    setOpacity( material.opacity );
    setBlending( material.blending );

    var scaleX = element.scale.x * _canvasWidthHalf;
    var scaleY = element.scale.y * _canvasHeightHalf;

    var dist = Math.sqrt( scaleX * scaleX + scaleY * scaleY ); // allow for rotated sprite
    _elemBox.min.set( v1.x - dist, v1.y - dist );
    _elemBox.max.set( v1.x + dist, v1.y + dist );

    if ( material.isSpriteMaterial ) {

        var texture = material.map;

        if ( texture !== null ) {

            var pattern = _patterns[ texture.id ];

            if ( pattern === undefined || pattern.version !== texture.version ) {

                pattern = textureToPattern( texture );
                _patterns[ texture.id ] = pattern;

            }

            if ( pattern.canvas !== undefined ) {

                setFillStyle( pattern.canvas );

                var bitmap = texture.image;

                var ox = bitmap.width * texture.offset.x;
                var oy = bitmap.height * texture.offset.y;

                var sx = bitmap.width * texture.repeat.x;
                var sy = bitmap.height * texture.repeat.y;

                var cx = scaleX / sx;
                var cy = scaleY / sy;

                _context.save();
                _context.translate( v1.x, v1.y );
                if ( material.rotation !== 0 ) _context.rotate( material.rotation );
                _context.translate( - scaleX / 2, - scaleY / 2 );
                _context.scale( cx, cy );
                _context.translate( - ox, - oy );
                _context.fillRect( ox, oy, sx, sy );
                _context.restore();

            }

        } else {

            // no texture

            setFillStyle( material.color.getStyle() );

            _context.save();
            _context.translate( v1.x, v1.y );
            if ( material.rotation !== 0 ) _context.rotate( material.rotation );
            _context.scale( scaleX, - scaleY );
            _context.fillRect( - 0.5, - 0.5, 1, 1 );
            _context.restore();

        }

    } else if ( material.isSpriteCanvasMaterial ) {

        setStrokeStyle( material.color.getStyle() );
        setFillStyle( material.color.getStyle() );

        _context.save();
        _context.translate( v1.x, v1.y );
        if ( material.rotation !== 0 ) _context.rotate( material.rotation );
        _context.scale( scaleX, scaleY );

        material.program( _context );

        _context.restore();

    } else if ( material.isPointsMaterial ) {

        setFillStyle( material.color.getStyle() );

        _context.save();
        _context.translate( v1.x, v1.y );
        if ( material.rotation !== 0 ) _context.rotate( material.rotation );
        _context.scale( scaleX * material.size, - scaleY * material.size );
        _context.fillRect( - 0.5, - 0.5, 1, 1 );
        _context.restore();

    }

    /* DEBUG
    setStrokeStyle( 'rgb(255,255,0)' );
    _context.beginPath();
    _context.moveTo( v1.x - 10, v1.y );
    _context.lineTo( v1.x + 10, v1.y );
    _context.moveTo( v1.x, v1.y - 10 );
    _context.lineTo( v1.x, v1.y + 10 );
    _context.stroke();
    */

}

function renderLine( v1, v2, element, material ) {

    setOpacity( material.opacity );
    setBlending( material.blending );

    _context.beginPath();
    _context.moveTo( v1.positionScreen.x, v1.positionScreen.y );
    _context.lineTo( v2.positionScreen.x, v2.positionScreen.y );

    if ( material.isLineBasicMaterial ) {

        setLineWidth( material.linewidth );
        setLineCap( material.linecap );
        setLineJoin( material.linejoin );

        if ( material.vertexColors !== THREE.VertexColors ) {

            setStrokeStyle( material.color.getStyle() );

        } else {

            var colorStyle1 = element.vertexColors[ 0 ].getStyle();
            var colorStyle2 = element.vertexColors[ 1 ].getStyle();

            if ( colorStyle1 === colorStyle2 ) {

                setStrokeStyle( colorStyle1 );

            } else {

                try {

                    var grad = _context.createLinearGradient(
                        v1.positionScreen.x,
                        v1.positionScreen.y,
                        v2.positionScreen.x,
                        v2.positionScreen.y
                    );
                    grad.addColorStop( 0, colorStyle1 );
                    grad.addColorStop( 1, colorStyle2 );

                } catch ( exception ) {

                    grad = colorStyle1;

                }

                setStrokeStyle( grad );

            }

        }

        if ( material.isLineDashedMaterial ) {

            setLineDash( [ material.dashSize, material.gapSize ] );

        }

        _context.stroke();
        _elemBox.expandByScalar( material.linewidth * 2 );

        if ( material.isLineDashedMaterial ) {

            setLineDash( [] );

        }

    }

}

function renderFace3( v1, v2, v3, uv1, uv2, uv3, element, material ) {

    _this.info.render.vertices += 3;
    _this.info.render.faces ++;

    setOpacity( material.opacity );
    setBlending( material.blending );

    _v1x = v1.positionScreen.x; _v1y = v1.positionScreen.y;
    _v2x = v2.positionScreen.x; _v2y = v2.positionScreen.y;
    _v3x = v3.positionScreen.x; _v3y = v3.positionScreen.y;

    drawTriangle( _v1x, _v1y, _v2x, _v2y, _v3x, _v3y );

    if ( ( material.isMeshLambertMaterial || material.isMeshPhongMaterial || material.isMeshStandardMaterial ) && material.map === null ) {

        _diffuseColor.copy( material.color );
        _emissiveColor.copy( material.emissive );

        if ( material.vertexColors === THREE.FaceColors ) {

            _diffuseColor.multiply( element.color );

        }

        _color.copy( _ambientLight );

        _centroid.copy( v1.positionWorld ).add( v2.positionWorld ).add( v3.positionWorld ).divideScalar( 3 );

        calculateLight( _centroid, element.normalModel, _color );

        _color.multiply( _diffuseColor ).add( _emissiveColor );

        material.wireframe === true
             ? strokePath( _color, material.wireframeLinewidth, material.wireframeLinecap, material.wireframeLinejoin )
             : fillPath( _color );

    } else if ( material.isMeshBasicMaterial || material.isMeshLambertMaterial || material.isMeshPhongMaterial || material.isMeshStandardMaterial ) {

        if ( material.map !== null ) {

            var mapping = material.map.mapping;

            if ( mapping === THREE.UVMapping ) {

                _uvs = element.uvs;
                patternPath( _v1x, _v1y, _v2x, _v2y, _v3x, _v3y, _uvs[ uv1 ].x, _uvs[ uv1 ].y, _uvs[ uv2 ].x, _uvs[ uv2 ].y, _uvs[ uv3 ].x, _uvs[ uv3 ].y, material.map );

            }

        } else if ( material.envMap !== null ) {

            if ( material.envMap.mapping === THREE.SphericalReflectionMapping ) {

                _normal.copy( element.vertexNormalsModel[ uv1 ] ).applyMatrix3( _normalViewMatrix );
                _uv1x = 0.5 * _normal.x + 0.5;
                _uv1y = 0.5 * _normal.y + 0.5;

                _normal.copy( element.vertexNormalsModel[ uv2 ] ).applyMatrix3( _normalViewMatrix );
                _uv2x = 0.5 * _normal.x + 0.5;
                _uv2y = 0.5 * _normal.y + 0.5;

                _normal.copy( element.vertexNormalsModel[ uv3 ] ).applyMatrix3( _normalViewMatrix );
                _uv3x = 0.5 * _normal.x + 0.5;
                _uv3y = 0.5 * _normal.y + 0.5;

                patternPath( _v1x, _v1y, _v2x, _v2y, _v3x, _v3y, _uv1x, _uv1y, _uv2x, _uv2y, _uv3x, _uv3y, material.envMap );

            }

        } else {

            _color.copy( material.color );

            if ( material.vertexColors === THREE.FaceColors ) {

                _color.multiply( element.color );

            }

            material.wireframe === true
                 ? strokePath( _color, material.wireframeLinewidth, material.wireframeLinecap, material.wireframeLinejoin )
                 : fillPath( _color );

        }

    } else if ( material.isMeshNormalMaterial ) {

        _normal.copy( element.normalModel ).applyMatrix3( _normalViewMatrix );

        _color.setRGB( _normal.x, _normal.y, _normal.z ).multiplyScalar( 0.5 ).addScalar( 0.5 );

        material.wireframe === true
             ? strokePath( _color, material.wireframeLinewidth, material.wireframeLinecap, material.wireframeLinejoin )
             : fillPath( _color );

    } else {

        _color.setRGB( 1, 1, 1 );

        material.wireframe === true
             ? strokePath( _color, material.wireframeLinewidth, material.wireframeLinecap, material.wireframeLinejoin )
             : fillPath( _color );

    }

}

//

function drawTriangle( x0, y0, x1, y1, x2, y2 ) {

    _context.beginPath();
    _context.moveTo( x0, y0 );
    _context.lineTo( x1, y1 );
    _context.lineTo( x2, y2 );
    _context.closePath();

}

function strokePath( color, linewidth, linecap, linejoin ) {

    setLineWidth( linewidth );
    setLineCap( linecap );
    setLineJoin( linejoin );
    setStrokeStyle( color.getStyle() );

    _context.stroke();

    _elemBox.expandByScalar( linewidth * 2 );

}

function fillPath( color ) {

    setFillStyle( color.getStyle() );
    _context.fill();

}

function textureToPattern( texture ) {

    if ( texture.version === 0 ||
        texture instanceof THREE.CompressedTexture ||
        texture instanceof THREE.DataTexture ) {

        return {
            canvas: undefined,
            version: texture.version
        };

    }

    var image = texture.image;

    if ( image.complete === false ) {

        return {
            canvas: undefined,
            version: 0
        };

    }

    var repeatX = texture.wrapS === THREE.RepeatWrapping || texture.wrapS === THREE.MirroredRepeatWrapping;
    var repeatY = texture.wrapT === THREE.RepeatWrapping || texture.wrapT === THREE.MirroredRepeatWrapping;

    var mirrorX = texture.wrapS === THREE.MirroredRepeatWrapping;
    var mirrorY = texture.wrapT === THREE.MirroredRepeatWrapping;

    //

    var canvas = document.createElement( 'canvas' );
    canvas.width = image.width * ( mirrorX ? 2 : 1 );
    canvas.height = image.height * ( mirrorY ? 2 : 1 );

    var context = canvas.getContext( '2d' );
    context.setTransform( 1, 0, 0, - 1, 0, image.height );
    context.drawImage( image, 0, 0 );

    if ( mirrorX === true ) {

        context.setTransform( - 1, 0, 0, - 1, image.width, image.height );
        context.drawImage( image, - image.width, 0 );

    }

    if ( mirrorY === true ) {

        context.setTransform( 1, 0, 0, 1, 0, 0 );
        context.drawImage( image, 0, image.height );

    }

    if ( mirrorX === true && mirrorY === true ) {

        context.setTransform( - 1, 0, 0, 1, image.width, 0 );
        context.drawImage( image, - image.width, image.height );

    }

    var repeat = 'no-repeat';

    if ( repeatX === true && repeatY === true ) {

        repeat = 'repeat';

    } else if ( repeatX === true ) {

        repeat = 'repeat-x';

    } else if ( repeatY === true ) {

        repeat = 'repeat-y';

    }

    var pattern = _context.createPattern( canvas, repeat );

    if ( texture.onUpdate ) texture.onUpdate( texture );

    return {
        canvas: pattern,
        version: texture.version
    };

}

function patternPath( x0, y0, x1, y1, x2, y2, u0, v0, u1, v1, u2, v2, texture ) {

    var pattern = _patterns[ texture.id ];

    if ( pattern === undefined || pattern.version !== texture.version ) {

        pattern = textureToPattern( texture );
        _patterns[ texture.id ] = pattern;

    }

    if ( pattern.canvas !== undefined ) {

        setFillStyle( pattern.canvas );

    } else {

        setFillStyle( 'rgba( 0, 0, 0, 1)' );
        _context.fill();
        return;

    }

    // http://extremelysatisfactorytotalitarianism.com/blog/?p=2120

    var a, b, c, d, e, f, det, idet,
        offsetX = texture.offset.x / texture.repeat.x,
        offsetY = texture.offset.y / texture.repeat.y,
        width = texture.image.width * texture.repeat.x,
        height = texture.image.height * texture.repeat.y;

    u0 = ( u0 + offsetX ) * width;
    v0 = ( v0 + offsetY ) * height;

    u1 = ( u1 + offsetX ) * width;
    v1 = ( v1 + offsetY ) * height;

    u2 = ( u2 + offsetX ) * width;
    v2 = ( v2 + offsetY ) * height;

    x1 -= x0; y1 -= y0;
    x2 -= x0; y2 -= y0;

    u1 -= u0; v1 -= v0;
    u2 -= u0; v2 -= v0;

    det = u1 * v2 - u2 * v1;

    if ( det === 0 ) return;

    idet = 1 / det;

    a = ( v2 * x1 - v1 * x2 ) * idet;
    b = ( v2 * y1 - v1 * y2 ) * idet;
    c = ( u1 * x2 - u2 * x1 ) * idet;
    d = ( u1 * y2 - u2 * y1 ) * idet;

    e = x0 - a * u0 - c * v0;
    f = y0 - b * u0 - d * v0;

    _context.save();
    _context.transform( a, b, c, d, e, f );
    _context.fill();
    _context.restore();

}

/*
function clipImage( x0, y0, x1, y1, x2, y2, u0, v0, u1, v1, u2, v2, image ) {

    // http://extremelysatisfactorytotalitarianism.com/blog/?p=2120

    var a, b, c, d, e, f, det, idet,
    width = image.width - 1,
    height = image.height - 1;

    u0 *= width; v0 *= height;
    u1 *= width; v1 *= height;
    u2 *= width; v2 *= height;

    x1 -= x0; y1 -= y0;
    x2 -= x0; y2 -= y0;

    u1 -= u0; v1 -= v0;
    u2 -= u0; v2 -= v0;

    det = u1 * v2 - u2 * v1;

    idet = 1 / det;

    a = ( v2 * x1 - v1 * x2 ) * idet;
    b = ( v2 * y1 - v1 * y2 ) * idet;
    c = ( u1 * x2 - u2 * x1 ) * idet;
    d = ( u1 * y2 - u2 * y1 ) * idet;

    e = x0 - a * u0 - c * v0;
    f = y0 - b * u0 - d * v0;

    _context.save();
    _context.transform( a, b, c, d, e, f );
    _context.clip();
    _context.drawImage( image, 0, 0 );
    _context.restore();

}
*/

// Hide anti-alias gaps

function expand( v1, v2, pixels ) {

    var x = v2.x - v1.x, y = v2.y - v1.y,
        det = x * x + y * y, idet;

    if ( det === 0 ) return;

    idet = pixels / Math.sqrt( det );

    x *= idet; y *= idet;

    v2.x += x; v2.y += y;
    v1.x -= x; v1.y -= y;

}

// Context cached methods.

function setOpacity( value ) {

    if ( _contextGlobalAlpha !== value ) {

        _context.globalAlpha = value;
        _contextGlobalAlpha = value;

    }

}

function setBlending( value ) {

    if ( _contextGlobalCompositeOperation !== value ) {

        if ( value === THREE.NormalBlending ) {

            _context.globalCompositeOperation = 'source-over';

        } else if ( value === THREE.AdditiveBlending ) {

            _context.globalCompositeOperation = 'lighter';

        } else if ( value === THREE.SubtractiveBlending ) {

            _context.globalCompositeOperation = 'darker';

        } else if ( value === THREE.MultiplyBlending ) {

            _context.globalCompositeOperation = 'multiply';

        }

        _contextGlobalCompositeOperation = value;

    }

}

function setLineWidth( value ) {

    if ( _contextLineWidth !== value ) {

        _context.lineWidth = value;
        _contextLineWidth = value;

    }

}

function setLineCap( value ) {

    // "butt", "round", "square"

    if ( _contextLineCap !== value ) {

        _context.lineCap = value;
        _contextLineCap = value;

    }

}

function setLineJoin( value ) {

    // "round", "bevel", "miter"

    if ( _contextLineJoin !== value ) {

        _context.lineJoin = value;
        _contextLineJoin = value;

    }

}

function setStrokeStyle( value ) {

    if ( _contextStrokeStyle !== value ) {

        _context.strokeStyle = value;
        _contextStrokeStyle = value;

    }

}

function setFillStyle( value ) {

    if ( _contextFillStyle !== value ) {

        _context.fillStyle = value;
        _contextFillStyle = value;

    }

}

function setLineDash( value ) {

    if ( _contextLineDash.length !== value.length ) {

        _context.setLineDash( value );
        _contextLineDash = value;

    }

}

};
    </script>
    <script>
        /**
 * @author qiao / https://github.com/qiao
 * @author mrdoob / http://mrdoob.com
 * @author alteredq / http://alteredqualia.com/
 * @author WestLangley / http://github.com/WestLangley
 * @author erich666 / http://erichaines.com
 */
/*global THREE, console */

// This set of controls performs orbiting, dollying (zooming), and panning. It maintains
// the "up" direction as +Y, unlike the TrackballControls. Touch on tablet and phones is
// supported.
//
//    Orbit - left mouse / touch: one finger move
//    Zoom - middle mouse, or mousewheel / touch: two finger spread or squish
//    Pan - right mouse, or arrow keys / touch: three finter swipe
//
// This is a drop-in replacement for (most) TrackballControls used in examples.
// That is, include this js file and wherever you see:
//    	controls = new THREE.TrackballControls( camera );
//      controls.target.z = 150;
// Simple substitute "OrbitControls" and the control should work as-is.

THREE.OrbitControls = function ( object, domElement ) {

this.object = object;
this.domElement = ( domElement !== undefined ) ? domElement : document;

// API

// Set to false to disable this control
this.enabled = true;

// "target" sets the location of focus, where the control orbits around
// and where it pans with respect to.
this.target = new THREE.Vector3();

// center is old, deprecated; use "target" instead
this.center = this.target;

// This option actually enables dollying in and out; left as "zoom" for
// backwards compatibility
this.noZoom = false;
this.zoomSpeed = 1.0;

// Limits to how far you can dolly in and out
this.minDistance = 0;
this.maxDistance = Infinity;

// Set to true to disable this control
this.noRotate = false;
this.rotateSpeed = 1.0;

// Set to true to disable this control
this.noPan = false;
this.keyPanSpeed = 7.0;	// pixels moved per arrow key push

// Set to true to automatically rotate around the target
this.autoRotate = false;
this.autoRotateSpeed = 2.0; // 30 seconds per round when fps is 60

// How far you can orbit vertically, upper and lower limits.
// Range is 0 to Math.PI radians.
this.minPolarAngle = 0; // radians
this.maxPolarAngle = Math.PI; // radians

// Set to true to disable use of the keys
this.noKeys = false;

// The four arrow keys
this.keys = { LEFT: 37, UP: 38, RIGHT: 39, BOTTOM: 40 };

////////////
// internals

var scope = this;

var EPS = 0.000001;

var rotateStart = new THREE.Vector2();
var rotateEnd = new THREE.Vector2();
var rotateDelta = new THREE.Vector2();

var panStart = new THREE.Vector2();
var panEnd = new THREE.Vector2();
var panDelta = new THREE.Vector2();
var panOffset = new THREE.Vector3();

var offset = new THREE.Vector3();

var dollyStart = new THREE.Vector2();
var dollyEnd = new THREE.Vector2();
var dollyDelta = new THREE.Vector2();

var phiDelta = 0;
var thetaDelta = 0;
var scale = 1;
var pan = new THREE.Vector3();

var lastPosition = new THREE.Vector3();

var STATE = { NONE : -1, ROTATE : 0, DOLLY : 1, PAN : 2, TOUCH_ROTATE : 3, TOUCH_DOLLY : 4, TOUCH_PAN : 5 };

var state = STATE.NONE;

// for reset

this.target0 = this.target.clone();
this.position0 = this.object.position.clone();

// events

var changeEvent = { type: 'change' };
var startEvent = { type: 'start'};
var endEvent = { type: 'end'};

this.rotateLeft = function ( angle ) {

    if ( angle === undefined ) {

        angle = getAutoRotationAngle();

    }

    thetaDelta -= angle;

};

this.rotateUp = function ( angle ) {

    if ( angle === undefined ) {

        angle = getAutoRotationAngle();

    }

    phiDelta -= angle;

};

// pass in distance in world space to move left
this.panLeft = function ( distance ) {

    var te = this.object.matrix.elements;

    // get X column of matrix
    panOffset.set( te[ 0 ], te[ 1 ], te[ 2 ] );
    panOffset.multiplyScalar( - distance );
    
    pan.add( panOffset );

};

// pass in distance in world space to move up
this.panUp = function ( distance ) {

    var te = this.object.matrix.elements;

    // get Y column of matrix
    panOffset.set( te[ 4 ], te[ 5 ], te[ 6 ] );
    panOffset.multiplyScalar( distance );
    
    pan.add( panOffset );

};

// pass in x,y of change desired in pixel space,
// right and down are positive
this.pan = function ( deltaX, deltaY ) {

    var element = scope.domElement === document ? scope.domElement.body : scope.domElement;

    if ( scope.object.fov !== undefined ) {

        // perspective
        var position = scope.object.position;
        var offset = position.clone().sub( scope.target );
        var targetDistance = offset.length();

        // half of the fov is center to top of screen
        targetDistance *= Math.tan( ( scope.object.fov / 2 ) * Math.PI / 180.0 );

        // we actually don't use screenWidth, since perspective camera is fixed to screen height
        scope.panLeft( 2 * deltaX * targetDistance / element.clientHeight );
        scope.panUp( 2 * deltaY * targetDistance / element.clientHeight );

    } else if ( scope.object.top !== undefined ) {

        // orthographic
        scope.panLeft( deltaX * (scope.object.right - scope.object.left) / element.clientWidth );
        scope.panUp( deltaY * (scope.object.top - scope.object.bottom) / element.clientHeight );

    } else {

        // camera neither orthographic or perspective
        console.warn( 'WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.' );

    }

};

this.dollyIn = function ( dollyScale ) {

    if ( dollyScale === undefined ) {

        dollyScale = getZoomScale();

    }

    scale /= dollyScale;

};

this.dollyOut = function ( dollyScale ) {

    if ( dollyScale === undefined ) {

        dollyScale = getZoomScale();

    }

    scale *= dollyScale;

};

this.update = function () {

    var position = this.object.position;

    offset.copy( position ).sub( this.target );

    // angle from z-axis around y-axis

    var theta = Math.atan2( offset.x, offset.z );

    // angle from y-axis

    var phi = Math.atan2( Math.sqrt( offset.x * offset.x + offset.z * offset.z ), offset.y );

    if ( this.autoRotate ) {

        this.rotateLeft( getAutoRotationAngle() );

    }

    theta += thetaDelta;
    phi += phiDelta;

    // restrict phi to be between desired limits
    phi = Math.max( this.minPolarAngle, Math.min( this.maxPolarAngle, phi ) );

    // restrict phi to be betwee EPS and PI-EPS
    phi = Math.max( EPS, Math.min( Math.PI - EPS, phi ) );

    var radius = offset.length() * scale;

    // restrict radius to be between desired limits
    radius = Math.max( this.minDistance, Math.min( this.maxDistance, radius ) );
    
    // move target to panned location
    this.target.add( pan );

    offset.x = radius * Math.sin( phi ) * Math.sin( theta );
    offset.y = radius * Math.cos( phi );
    offset.z = radius * Math.sin( phi ) * Math.cos( theta );

    position.copy( this.target ).add( offset );

    this.object.lookAt( this.target );

    thetaDelta = 0;
    phiDelta = 0;
    scale = 1;
    pan.set( 0, 0, 0 );

    if ( lastPosition.distanceTo( this.object.position ) > 0 ) {

        this.dispatchEvent( changeEvent );

        lastPosition.copy( this.object.position );

    }

};


this.reset = function () {

    state = STATE.NONE;

    this.target.copy( this.target0 );
    //this.object.position.copy( this.position0 );

    this.update();

};

function getAutoRotationAngle() {

    return 2 * Math.PI / 60 / 60 * scope.autoRotateSpeed;

}

function getZoomScale() {

    return Math.pow( 0.95, scope.zoomSpeed );

}

function onMouseDown( event ) {

    if ( scope.enabled === false ) return;
    event.preventDefault();

    if ( event.button === 0 ) {
        if ( scope.noRotate === true ) return;

        state = STATE.ROTATE;

        rotateStart.set( event.clientX, event.clientY );

    } else if ( event.button === 1 ) {
        if ( scope.noZoom === true ) return;

        state = STATE.DOLLY;

        dollyStart.set( event.clientX, event.clientY );

    } else if ( event.button === 2 ) {
        if ( scope.noPan === true ) return;

        state = STATE.PAN;

        panStart.set( event.clientX, event.clientY );

    }

    scope.domElement.addEventListener( 'mousemove', onMouseMove, false );
    scope.domElement.addEventListener( 'mouseup', onMouseUp, false );
    scope.dispatchEvent( startEvent );

}

function onMouseMove( event ) {

    if ( scope.enabled === false ) return;

    event.preventDefault();

    var element = scope.domElement === document ? scope.domElement.body : scope.domElement;

    if ( state === STATE.ROTATE ) {

        if ( scope.noRotate === true ) return;

        rotateEnd.set( event.clientX, event.clientY );
        rotateDelta.subVectors( rotateEnd, rotateStart );

        // rotating across whole screen goes 360 degrees around
        scope.rotateLeft( 2 * Math.PI * rotateDelta.x / element.clientWidth * scope.rotateSpeed );

        // rotating up and down along whole screen attempts to go 360, but limited to 180
        scope.rotateUp( 2 * Math.PI * rotateDelta.y / element.clientHeight * scope.rotateSpeed );

        rotateStart.copy( rotateEnd );

    } else if ( state === STATE.DOLLY ) {

        if ( scope.noZoom === true ) return;

        dollyEnd.set( event.clientX, event.clientY );
        dollyDelta.subVectors( dollyEnd, dollyStart );

        if ( dollyDelta.y > 0 ) {

            scope.dollyIn();

        } else {

            scope.dollyOut();

        }

        dollyStart.copy( dollyEnd );

    } else if ( state === STATE.PAN ) {

        if ( scope.noPan === true ) return;

        panEnd.set( event.clientX, event.clientY );
        panDelta.subVectors( panEnd, panStart );
        
        scope.pan( panDelta.x, panDelta.y );

        panStart.copy( panEnd );

    }

    scope.update();

}

function onMouseUp( /* event */ ) {

    if ( scope.enabled === false ) return;

    scope.domElement.removeEventListener( 'mousemove', onMouseMove, false );
    scope.domElement.removeEventListener( 'mouseup', onMouseUp, false );
    scope.dispatchEvent( endEvent );
    state = STATE.NONE;

}

function onMouseWheel( event ) {

    if ( scope.enabled === false || scope.noZoom === true ) return;

    event.preventDefault();

    var delta = 0;

    if ( event.wheelDelta !== undefined ) { // WebKit / Opera / Explorer 9

        delta = event.wheelDelta;

    } else if ( event.detail !== undefined ) { // Firefox

        delta = - event.detail;

    }

    if ( delta > 0 ) {

        scope.dollyOut();

    } else {

        scope.dollyIn();

    }

    scope.update();
    scope.dispatchEvent( startEvent );
    scope.dispatchEvent( endEvent );

}

function onKeyDown( event ) {

    if ( scope.enabled === false || scope.noKeys === true || scope.noPan === true ) return;
    
    switch ( event.keyCode ) {

        case scope.keys.UP:
            scope.pan( 0, scope.keyPanSpeed );
            scope.update();
            break;

        case scope.keys.BOTTOM:
            scope.pan( 0, - scope.keyPanSpeed );
            scope.update();
            break;

        case scope.keys.LEFT:
            scope.pan( scope.keyPanSpeed, 0 );
            scope.update();
            break;

        case scope.keys.RIGHT:
            scope.pan( - scope.keyPanSpeed, 0 );
            scope.update();
            break;

    }

}

function touchstart( event ) {

    if ( scope.enabled === false ) return;

    switch ( event.touches.length ) {

        case 1:	// one-fingered touch: rotate

            if ( scope.noRotate === true ) return;

            state = STATE.TOUCH_ROTATE;

            rotateStart.set( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY );
            break;

        case 2:	// two-fingered touch: dolly

            if ( scope.noZoom === true ) return;

            state = STATE.TOUCH_DOLLY;

            var dx = event.touches[ 0 ].pageX - event.touches[ 1 ].pageX;
            var dy = event.touches[ 0 ].pageY - event.touches[ 1 ].pageY;
            var distance = Math.sqrt( dx * dx + dy * dy );
            dollyStart.set( 0, distance );
            break;

        case 3: // three-fingered touch: pan

            if ( scope.noPan === true ) return;

            state = STATE.TOUCH_PAN;

            panStart.set( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY );
            break;

        default:

            state = STATE.NONE;

    }

    scope.dispatchEvent( startEvent );

}

function touchmove( event ) {

    if ( scope.enabled === false ) return;

    event.preventDefault();
    event.stopPropagation();

    var element = scope.domElement === document ? scope.domElement.body : scope.domElement;

    switch ( event.touches.length ) {

        case 1: // one-fingered touch: rotate

            if ( scope.noRotate === true ) return;
            if ( state !== STATE.TOUCH_ROTATE ) return;

            rotateEnd.set( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY );
            rotateDelta.subVectors( rotateEnd, rotateStart );

            // rotating across whole screen goes 360 degrees around
            scope.rotateLeft( 2 * Math.PI * rotateDelta.x / element.clientWidth * scope.rotateSpeed );
            // rotating up and down along whole screen attempts to go 360, but limited to 180
            scope.rotateUp( 2 * Math.PI * rotateDelta.y / element.clientHeight * scope.rotateSpeed );

            rotateStart.copy( rotateEnd );

            scope.update();
            break;

        case 2: // two-fingered touch: dolly

            if ( scope.noZoom === true ) return;
            if ( state !== STATE.TOUCH_DOLLY ) return;

            var dx = event.touches[ 0 ].pageX - event.touches[ 1 ].pageX;
            var dy = event.touches[ 0 ].pageY - event.touches[ 1 ].pageY;
            var distance = Math.sqrt( dx * dx + dy * dy );

            dollyEnd.set( 0, distance );
            dollyDelta.subVectors( dollyEnd, dollyStart );

            if ( dollyDelta.y > 0 ) {

                scope.dollyOut();

            } else {

                scope.dollyIn();

            }

            dollyStart.copy( dollyEnd );

            scope.update();
            break;

        case 3: // three-fingered touch: pan

            if ( scope.noPan === true ) return;
            if ( state !== STATE.TOUCH_PAN ) return;

            panEnd.set( event.touches[ 0 ].pageX, event.touches[ 0 ].pageY );
            panDelta.subVectors( panEnd, panStart );
            
            scope.pan( panDelta.x, panDelta.y );

            panStart.copy( panEnd );

            scope.update();
            break;

        default:

            state = STATE.NONE;

    }

}

function touchend( /* event */ ) {

    if ( scope.enabled === false ) return;

    scope.dispatchEvent( endEvent );
    state = STATE.NONE;

}

this.domElement.addEventListener( 'contextmenu', function ( event ) { event.preventDefault(); }, false );
this.domElement.addEventListener( 'mousedown', onMouseDown, false );
this.domElement.addEventListener( 'mousewheel', onMouseWheel, false );
this.domElement.addEventListener( 'DOMMouseScroll', onMouseWheel, false ); // firefox

this.domElement.addEventListener( 'touchstart', touchstart, false );
this.domElement.addEventListener( 'touchend', touchend, false );
this.domElement.addEventListener( 'touchmove', touchmove, false );

window.addEventListener( 'keydown', onKeyDown, false );

};

THREE.OrbitControls.prototype = Object.create( THREE.EventDispatcher.prototype );
    </script>
  </head>

  <body>
    <div id="stl_cont" style="width: 500px; height: 500px; margin: 0 auto">
      <canvas
        width="500"
        height="500"
        style="width: 500px; height: 500px"
      ></canvas>
    </div>

    <script>
      //=========== Stl Viewer v1.13, by Omri Rips, Viewstl.com, July 2021 ; admin@viewstl.com ===========
      var stl_viewer_script_path = "";
      function StlViewer(e, t) {
        e || console.log("error: no parent element");
        var o = this;
        (this.error = null),
          (this.options = t),
          (this.parent_element = e),
          (this.get_opt = function (e, t) {
            return o.options
              ? !1 !== o.options[e] && (o.options[e] ? o.options[e] : t)
              : t;
          }),
          (this.canvas_width = "100%"),
          (this.canvas_height = "100%"),
          (this.bg_color = "transparent"),
          (this.models_to_add = []),
          (this.models = []),
          (this.models_count = 0),
          (this.models_ref = []),
          (this.allow_drag_and_drop = o.get_opt("allow_drag_and_drop", !0)),
          (this.model_loaded_callback = null),
          (this.all_loaded_callback = null),
          (this.load_error_callback = null),
          (this.loading_progress_callback = null),
          (this.max_model_id = 0),
          (this.load_status = []),
          (this.load_session = 0),
          (this.loaded_models_arr = []),
          (this.status = 0),
          (this.onmousedown_callback = null),
          (this.zoom = -1),
          (this.camerax = 0),
          (this.cameray = 0),
          (this.cameraz = 0),
          (this.camera_state = null),
          (this.auto_rotate = !1),
          (this.mouse_zoom = !0),
          (this.load_three_files = o.get_opt(
            "load_three_files",
            stl_viewer_script_path
          )),
          (this.ready = "undefined" != typeof THREE),
          (this.ready_callback = null),
          (this.jszip_path = null),
          (this.jszip_utils_path = null),
          (this.auto_resize = !0),
          (this.on_model_drop = null),
          (this.center_models = !0),
          (this.controls_type = 0),
          (this.zoom = -1),
          (this.pre_loaded_ab_files = null),
          (this.pre_loaded_vsj = null),
          (this.zip_load_count = -1),
          (this.send_no_model_click_event = !1),
          (this.grid = null),
          (this.killsign = !1),
          (this.default_face_color = "#909090"),
          (this.set_on_model_mousedown = function (e) {
            (o.onmousedown_callback = e),
              o.onmousedown_callback &&
                (o.parent_element.addEventListener("mousedown", o.onmousedown),
                o.parent_element.addEventListener("dblclick", o.onmousedown),
                o.parent_element.addEventListener("touchstart", o.onmousedown));
          }),
          (this.set_drag_and_drop = function (e) {
            e
              ? (o.parent_element.addEventListener(
                  "dragover",
                  o.handleDragOver
                ),
                o.parent_element.addEventListener("drop", o.handleFileDrop))
              : (o.parent_element.removeEventListener(
                  "dragover",
                  o.handleDragOver
                ),
                o.parent_element.removeEventListener("drop", o.handleFileDrop));
          }),
          (this.set_options = function () {
            (o.canvas_width = o.get_opt("width", o.canvas_width)),
              (o.canvas_height = o.get_opt("height", o.canvas_height)),
              (o.bg_color = o.get_opt("bg_color", o.bg_color)),
              (o.models_to_add = o.get_opt("models", o.models_to_add)),
              (o.model_loaded_callback = o.get_opt(
                "model_loaded_callback",
                o.model_loaded_callback
              )),
              (o.all_loaded_callback = o.get_opt(
                "all_loaded_callback",
                o.all_loaded_callback
              )),
              (o.load_error_callback = o.get_opt(
                "load_error_callback",
                o.load_error_callback
              )),
              (o.loading_progress_callback = o.get_opt(
                "loading_progress_callback",
                o.loading_progress_callback
              )),
              (o.onmousedown_callback = o.get_opt(
                "on_model_mousedown",
                o.onmousedown_callback
              )),
              o.onmousedown_callback ||
                (o.onmousedown_callback = o.get_opt(
                  "on_model_mouseclick",
                  null
                )),
              (o.send_no_model_click_event = o.get_opt(
                "send_no_model_click_event",
                o.send_no_model_click_event
              )),
              (o.zoom = o.get_opt("zoom", o.zoom)),
              (o.camerax = o.get_opt("camerax", o.camerax)),
              (o.cameray = o.get_opt("cameray", o.cameray)),
              (o.auto_rotate = o.get_opt("auto_rotate", o.auto_rotate)),
              (o.mouse_zoom = o.get_opt("mouse_zoom", o.mouse_zoom)),
              (o.ready_callback = o.get_opt("ready_callback", null)),
              (o.jszip_path = o.get_opt("jszip_path", null)),
              (o.jszip_utils_path = o.get_opt("jszip_utils_path", null)),
              (o.auto_resize = o.get_opt("auto_resize", o.auto_resize)),
              (o.on_model_drop = o.get_opt("on_model_drop", o.on_model_drop)),
              (o.center_models = o.get_opt("center_models", o.center_models)),
              (o.controls_type = o.get_opt("controls", o.controls_type)),
              (o.grid = o.get_opt("grid", !!o.grid)),
              o.zoom >= 0
                ? (o.cameraz = o.zoom)
                : (o.cameraz = o.get_opt("cameraz", o.cameraz)),
              (o.camera_state = o.get_opt("camera_state", o.camera_state)),
              o.allow_drag_and_drop && o.set_drag_and_drop(!0);
          }),
          (o.is_ie = !!window.MSStream),
          (this.MSG2WORKER_DATA = 0),
          (this.MSG2WORKER_LOAD = 1),
          (this.MSG2WORKER_ERROR = 2),
          (this.MSGFROMWORKER_STL_LOADED = 3),
          (this.MSGFROMWORKER_LOAD_IN_PROGRESS = 4),
          (this.load_model = function (e) {
            return (
              (o.max_model_id = Math.max(o.max_model_id, e.id)),
              e.filename || e.local_file
                ? o.load_from_stl_file(e, !1)
                : e.mesh
                ? o.add_from_existing_mesh(e)
                : void o.models_count--
            );
          }),
          (this.add_from_existing_mesh = function (e) {
            o.set_model_custom_props(e),
              (e.mesh.model_id = e.id),
              o.set_geo_minmax(e),
              o.recalc_dims(e),
              (e.color = "#" + e.mesh.material.color.getHexString()),
              o.scene.add(e.mesh),
              o.model_loaded(e.id),
              o.check_loading_status(e, 0, 0),
              e.mesh.geometry.boundingBox ||
                e.mesh.geometry.computeBoundingBox(),
              o.model_loaded_callback && o.model_loaded_callback(e.id);
          }),
          (this.load_from_stl_file = function (e) {
            var t = new Worker(
              ("string" == typeof o.load_three_files
                ? o.load_three_files
                : "") + "load_stl.min.js"
            );
            (t.onmessage = function (a) {
              switch (a.data.msg_type) {
                case o.MSGFROMWORKER_STL_LOADED:
                  e.colors = a.data.colors;
                  var i = o.vf_to_geo(
                    a.data.vertices,
                    a.data.faces,
                    !!a.data.colors && a.data.colors,
                    e.color
                  );
                  if (i) {
                    var n = new THREE.MeshLambertMaterial({
                      color: 9474192,
                      wireframe: !1,
                      vertexColors: e.color ? THREE.NoColors : THREE.FaceColors,
                    });
                    o.is_ie || (n.side = THREE.DoubleSide),
                      e.display || (e.display = "flat"),
                      o.set_material_display(e.display, n, i),
                      (e.mesh = new THREE.Mesh(i, n)),
                      o.set_model_custom_props(e),
                      o.set_geo_minmax(e),
                      (e.mesh.model_id = e.id),
                      o.recalc_dims(e),
                      o.scene.add(e.mesh),
                      o.model_loaded(e.id),
                      o.model_loaded_callback && o.model_loaded_callback(e.id);
                  } else console.log("Error VF data ");
                  t.terminate(),
                    (t = void 0),
                    o.pre_loaded_ab_files &&
                      e.filename &&
                      o.pre_loaded_ab_files[e.filename] &&
                      delete o.pre_loaded_ab_files[e.filename];
                  break;
                case o.MSGFROMWORKER_LOAD_IN_PROGRESS:
                  o.check_loading_status(e, a.data.loaded, a.data.total);
                  break;
                case o.MSG2WORKER_ERROR:
                  o.models_count--,
                    o.model_error(
                      "ERROR: " + a.data.data,
                      o.load_error_callback
                    ),
                    o.pre_loaded_ab_files &&
                      e.filename &&
                      o.pre_loaded_ab_files[e.filename] &&
                      delete o.pre_loaded_ab_files[e.filename];
              }
            }),
              (e.bytes_loaded = 0),
              (e.bytes_total = 0);
            var a = null;
            o.pre_loaded_ab_files &&
              e.filename &&
              o.pre_loaded_ab_files[e.filename] &&
              (a = o.pre_loaded_ab_files[e.filename]),
              t.postMessage({
                msg_type: o.MSG2WORKER_DATA,
                data: e,
                load_from_blob_or_ab: a,
                get_progress: null != o.loading_progress_callback,
                jszip_path: o.jszip_path,
              }),
              t.postMessage({ msg_type: o.MSG2WORKER_LOAD });
          }),
          (this.model_loaded = function (e) {
            (o.loaded_models_arr[e] = 1),
              Object.keys(o.loaded_models_arr).length >= o.models_count &&
                (o.camera_state ? (o.camera_state = null) : o.set_zoom(),
                o.set_light(),
                o.set_grid(!!o.grid),
                o.load_session++,
                o.all_loaded_callback && o.all_loaded_callback());
          }),
          (this.set_grid = function (e, t, a) {
            if ((o.grid && o.scene.remove(o.grid), (o.grid = null), e)) {
              if (
                (t || (t = 2.5 * Math.max(Math.abs(o.maxx), Math.abs(o.minx))),
                t <= 0)
              ) {
                var i = isNaN(window.innerHeight)
                    ? window.clientHeight
                    : window.innerHeight,
                  n = isNaN(window.innerWidth)
                    ? window.clientWidth
                    : window.innerWidth;
                t = 0.8 * Math.min(i, n);
              }
              a || (a = 10),
                (o.grid = new THREE.GridHelper(t, a)),
                o.scene.add(o.grid);
            }
          }),
          (this.remove_model = function (e) {
            if (void 0 === o.models_ref[e])
              return o.model_error("remove_model - id not found: " + e);
            var t = o.models[o.models_ref[e]];
            t &&
              (o.set_or_update_geo_edges(t, !1),
              delete o.models[o.models_ref[e]],
              delete o.models_ref[e],
              delete o.loaded_models_arr[e],
              (o.max_model_id = -1),
              Object.keys(o.models_ref).forEach(function (e) {
                o.max_model_id = Math.max(
                  o.models[o.models_ref[e]].id,
                  o.max_model_id
                );
              }),
              (o.models_count = Object.keys(o.models).length),
              o.scene.remove(t.mesh));
          }),
          (this.zoom_done = !1),
          (this.set_zoom = function (e, t) {
            if ((e && (o.zoom = e), o.zoom_done && !t)) return;
            o.zoom_done = !0;
            var a = o.zoom;
            o.zoom < 0 && (a = o.calc_z_for_auto_zoom()),
              o.camera.position.set(
                o.camera.position.x,
                o.camera.position.y,
                a
              );
            const i = o.minz,
              n = i < 0 ? -i + a : a - i;
            (o.camera.far = Math.max(3e3 * n, o.camera.far)),
              o.camera.updateProjectionMatrix();
          }),
          (this.calc_z_for_auto_zoom = function (e) {
            e = e || 1.01;
            const t = new THREE.Box3(
              new THREE.Vector3(o.minx, o.miny, o.minz),
              new THREE.Vector3(o.maxx, o.maxy, o.maxz)
            );
            var a = new THREE.Vector3();
            t.getSize(a);
            const i = o.camera.fov * (Math.PI / 180),
              n = 2 * Math.atan(Math.tan(i / 2) * o.camera.aspect);
            let l = a.z / 2 + Math.abs(a.x / 2 / Math.tan(n / 2)),
              s = a.z / 2 + Math.abs(a.y / 2 / Math.tan(i / 2)),
              r = Math.max(l, s);
            return (r *= e);
          }),
          (this.get_camera_state = function () {
            if (!o.camera) return null;
            var e = new THREE.Vector3(),
              t = new THREE.Vector3(),
              a = new THREE.Vector3(0, 0, 0);
            return (
              e.copy(o.camera.position),
              t.copy(o.camera.up),
              o.controls && a.copy(o.controls.target),
              { position: e, up: t, target: a }
            );
          }),
          (this.set_camera_state = function (e) {
            if (!o.camera) return null;
            if (!e) return o.model_error("set_camera_state - no state vector");
            if (void 0 !== e.position) {
              if (void 0 === e.position.x)
                return o.model_error("set_camera_state - invalid position x");
              if (void 0 === e.position.y)
                return o.model_error("set_camera_state - invalid position y");
              if (void 0 === e.position.z)
                return o.model_error("set_camera_state - invalid position z");
              o.camera.position.set(e.position.x, e.position.y, e.position.z);
            }
            if (void 0 !== e.up) {
              if (void 0 === e.up.x)
                return o.model_error("set_camera_state invalid up x");
              if (void 0 === e.up.y)
                return o.model_error("set_camera_state invalid up y");
              if (void 0 === e.up.z)
                return o.model_error("set_camera_state invalid up z");
              o.camera.up.set(e.up.x, e.up.y, e.up.z);
            }
            if (o.controls && void 0 !== e.target) {
              if (void 0 === e.target.x)
                return o.model_error("set_camera_state - invalid target x");
              if (void 0 === e.target.y)
                return o.model_error("set_camera_state - invalid target y");
              if (void 0 === e.target.z)
                return o.model_error("set_camera_state - invalid target z");
              o.controls.target.set(e.target.x, e.target.y, e.target.z);
            }
          }),
          (this.set_center_models = function (e) {
            o.center_models = e;
          }),
          (this.set_light = function () {
            (o.directionalLight.position.x = 2 * o.maxy),
              (o.directionalLight.position.y = 2 * o.miny),
              (o.directionalLight.position.z = 2 * o.maxz),
              (o.pointLight.position.x = (o.miny + o.maxy) / 2),
              (o.pointLight.position.y = (o.miny + o.maxy) / 2),
              (o.pointLight.position.z = 2 * o.maxz);
          }),
          (this.stop_auto_zoom = function () {
            (o.zoom = o.camera.position.z), (o.zoom_done = !0);
          }),
          (this.set_camera = function (e, t, a) {
            t && (o.zoom = t),
              o.camera.position.set(
                o.is_empty(e) ? o.camera.position.x : e,
                o.is_empty(t) ? o.camera.position.y : t,
                o.is_empty(a) ? o.camera.position.z : a
              );
          }),
          (this.set_auto_zoom = function () {
            o.set_zoom(-1);
          }),
          (this.check_loading_status = function (e, t, a) {
            e &&
              (o.load_status[e.id] = {
                loaded: t,
                total: a,
                load_session: o.load_session,
              }),
              o.loading_progress_callback &&
                Object.keys(o.load_status).length == o.models_count &&
                o.loading_progress_callback(o.load_status, o.load_session);
          }),
          (this.set_edges = function (e, t) {
            if (void 0 === o.models_ref[e])
              return o.model_error("set_edges - id not found: " + e);
            var a = o.models[o.models_ref[e]];
            a && o.set_or_update_geo_edges(a, t);
          }),
          (this.set_or_update_geo_edges = function (e, t, a) {
            if (
              (t && !a) ||
              (e.edges && o.scene.remove(e.edges), (e.edges = null), t)
            ) {
              var i = !1;
              if (((a = a || !1), !e.edges || a)) {
                var n = e.mesh.geometry;
                (e.edges = new THREE.LineSegments(
                  new THREE.EdgesGeometry(n),
                  o.edges_material
                )),
                  (i = !0);
              }
              (e.x || e.y || e.z) &&
                e.edges.position.set(
                  e.x ? e.x : 0,
                  e.y ? e.y : 0,
                  e.z ? e.z : 0
                ),
                e.edges.rotation.setFromRotationMatrix(e.mesh.matrix),
                i && o.scene.add(e.edges);
            }
          }),
          (this.set_model_custom_props = function (e) {
            (e.units = e.units ? e.units : "mm"),
              o.set_model_units(e.id, e.units, !0),
              (e.x = e.x ? e.x : 0),
              (e.y = e.y ? e.y : 0),
              (e.z = e.z ? e.z : 0),
              e.mesh.position.set(e.x, e.y, e.z),
              e.color
                ? o.update_mesh_color(e.mesh, e.color, !1)
                : e.colors && o.update_mesh_color(e.mesh, "#FFFFFF", !0),
              (e.rotationx = e.rotationx ? e.rotationx : 0),
              (e.rotationy = e.rotationy ? e.rotationy : 0),
              (e.rotationz = e.rotationz ? e.rotationz : 0),
              (e.rotationx || e.rotationy || e.rotationz) &&
                o.set_rotation(e.id, e.rotationx, e.rotationy, e.rotationz);
            var t = void 0 !== e.scale ? e.scale : 1,
              a = void 0 !== e.scalex ? e.scalex : t,
              i = void 0 !== e.scaley ? e.scaley : t,
              n = void 0 !== e.scalez ? e.scalez : t;
            (e.scalex = a),
              (e.scaley = i),
              (e.scalez = n),
              (1 == a && 1 == i && 1 == n) || o.scale_geo(e, a, i, n),
              e.view_edges && o.set_or_update_geo_edges(e, !0),
              void 0 !== e.opacity &&
                this.set_material_opacity(e.mesh.material, e.opacity),
              e.animation && (o.animation[e.id] = 1);
          }),
          (this.set_scale = function (e, t, a, i, n) {
            if (void 0 === o.models_ref[e])
              return o.model_error("set_scale - id not found: " + e);
            var l = o.models[o.models_ref[e]];
            if (l && l.mesh && l.mesh.geometry) {
              var s = Math.max(l.scalex, 0.01),
                r = Math.max(l.scaley, 0.01),
                d = Math.max(l.scalez, 0.01);
              t && (l.scalex = Math.max(t, 0.01)),
                (l.scaley = Math.max(a || t, 0.01)),
                (l.scalez = Math.max(i || t, 0.01)),
                o.scale_geo(l, l.scalex / s, l.scaley / r, l.scalez / d),
                l.edges && o.set_or_update_geo_edges(l, !0, !0),
                n && ((l.scalex = s), (l.scaley = r), (l.scalez = d));
            }
          }),
          (this.scale_geo = function (e, t, o, a) {
            e.mesh.geometry.scale(t, o, a);
          }),
          (this.recalc_dims = function (e) {
            var t = e.mesh.geometry;
            (o.maxx = o.maxx ? Math.max(o.maxx, t.maxx + e.x) : t.maxx + e.x),
              (o.maxy = o.maxy ? Math.max(o.maxy, t.maxy + e.y) : t.maxy + e.y),
              (o.maxz = o.maxz ? Math.max(o.maxz, t.maxz + e.z) : t.maxz + e.z),
              (o.minx = o.maxx ? Math.min(o.minx, t.minx + e.x) : t.minx + e.x),
              (o.miny = o.maxy ? Math.min(o.miny, t.miny + e.y) : t.miny + e.y),
              (o.minz = o.maxz ? Math.min(o.minz, t.minz + e.z) : t.minz + e.z);
          }),
          (this.update_mesh_color = function (e, t, o) {
            null != e &&
              ("transparent" != t
                ? (e.traverse(function (e) {
                    e.visible = !0;
                  }),
                  (e.material.vertexColors = o
                    ? THREE.FaceColors
                    : THREE.NoColors),
                  o && !t && (t = "#FFFFFF"),
                  t && e.material.color.set(parseInt(t.substr(1), 16)),
                  (e.material.needsUpdate = !0))
                : e.traverse(function (e) {
                    e.visible = !1;
                  }));
          }),
          (this.set_color = function (e, t) {
            if (void 0 === o.models_ref[e])
              return o.model_error("set_color - id not found: " + e);
            var a = o.models[o.models_ref[e]];
            a &&
              a.mesh &&
              (t.length < 6 ||
                ("#" != t.charAt(0) && (t = "#" + t),
                (a.color = t),
                o.update_mesh_color(a.mesh, t, !t && a.colors)));
          }),
          (this.error_in_model = function (e) {
            if (!e.id && 0 != e.id && -1 != e.id)
              return o.model_error("missing id");
            if (!Number.isInteger(e.id)) return o.model_error("invalid id");
            if (e.id < -1) return o.model_error("id must be positive");
            if (!e.filename && !e.mesh && !e.local_file) {
              if (!e.name) return o.model_error("missing filename or mesh");
              e.filename = e.name;
            }
            return o.models_ref[e.id]
              ? o.model_error("such model ID already exists: " + e.id)
              : null;
          }),
          (this.model_error = function (e, t) {
            return console.log(e), (o.status = -1), (o.error = e), t && t(e), e;
          }),
          (this.set_bg_color = function (e) {
            "transparent" == e
              ? this.renderer.setClearColor(0, 0)
              : this.renderer.setClearColor(e, 1),
              (o.bg_color = e);
          }),
          (this.set_display = function (e, t) {
            if (void 0 === o.models_ref[e])
              return o.model_error("set_display - id not found: " + e);
            var a = o.models[o.models_ref[e]];
            a &&
              (o.set_material_display(t, a.mesh.material, a.mesh.geometry),
              (a.display = t),
              a.mesh && (a.mesh.normalsNeedUpdate = !0));
          }),
          (this.set_opacity = function (e, t) {
            if (void 0 === o.models_ref[e])
              return o.model_error("set_display - id not found: " + e);
            var a = o.models[o.models_ref[e]];
            a &&
              ((a.opacity = t), this.set_material_opacity(a.mesh.material, t));
          }),
          (this.set_material_opacity = function (e, t) {
            e &&
              (t < 1
                ? ((e.opacity = t), (e.transparent = !0))
                : ((e.opacity = 1), (e.transparent = !1)));
          }),
          (this.onmousedown = function (e) {
            e.stopPropagation(), e.preventDefault();
            var t = e.which;
            switch (e.type) {
              case "touchstart":
                t = 20;
                var a = e.touches[0] || e.changedTouches[0];
                (o.mouse.x =
                  ((a.pageX - o.parent_element.offsetLeft) /
                    o.parent_element.clientWidth) *
                    2 -
                  1),
                  (o.mouse.y =
                    (-(a.pageY - o.parent_element.offsetTop) /
                      o.parent_element.clientHeight) *
                      2 +
                    1);
                break;
              case "dblclick":
                t = 11;
              default:
                (o.mouse.x =
                  ((e.clientX - o.parent_element.offsetLeft) /
                    o.parent_element.clientWidth) *
                    2 -
                  1),
                  (o.mouse.y =
                    (-(e.clientY - o.parent_element.offsetTop) /
                      o.parent_element.clientHeight) *
                      2 +
                    1);
            }
            o.raycaster.setFromCamera(o.mouse, o.camera);
            var i = o.raycaster.intersectObjects(o.scene.children);
            if (i.length > 0) {
              if (void 0 === i[0].object.model_id) return;
              o.onmousedown_callback &&
                o.onmousedown_callback(
                  i[0].object.model_id,
                  e,
                  i[0].distance,
                  t
                );
            } else
              o.send_no_model_click_event &&
                o.onmousedown_callback(null, e, 0, t);
          }),
          (this.is_empty = function (e) {
            return !e && 0 !== e;
          }),
          (this.set_model_units = function (e, t, a) {
            if (void 0 === o.models_ref[e])
              return o.model_error("set_model_units - id not found: " + e);
            var i = o.models[o.models_ref[e]];
            if (i && i.mesh) {
              var n = 1;
              switch (t) {
                case "mm":
                  a && "inch" == i.units && (n = 1 / 25.4), (i.units = "mm");
                  break;
                case "inch":
                  a && "mm" == i.units && (n = 25.4), (i.units = "inch");
                  break;
                default:
                  return o.model_error("set_model_units - invalid unit " + t);
              }
              1 != n &&
                o.set_scale(i.id, i.scalex * n, i.scaley * n, i.scalez * n, !0);
            }
          }),
          (this.set_position = function (e, t, a, i) {
            if (void 0 === o.models_ref[e])
              return o.model_error("set_position - id not found: " + e);
            var n = o.models[o.models_ref[e]];
            n &&
              n.mesh &&
              ((n.x = o.is_empty(t) ? n.x : t),
              (n.y = o.is_empty(a) ? n.y : a),
              (n.z = o.is_empty(i) ? n.z : i),
              n.mesh.position.set(n.x, n.y, n.z),
              n.edges && o.set_or_update_geo_edges(n, !0, !0));
          }),
          (this.set_material_display = function (e, t, o) {
            switch (e.toLowerCase()) {
              case "wireframe":
                t.wireframe = !0;
                break;
              case "smooth":
                (t.wireframe = !1),
                  (t.flatShading = !1),
                  o && (o.mergeVertices(), o.computeVertexNormals());
                break;
              case "flat":
                (t.wireframe = !1),
                  (t.flatShading = !0),
                  o && o.computeFlatVertexNormals();
            }
          }),
          (this.set_rotation = function (e, t, a, i, n) {
            if (void 0 === o.models_ref[e])
              return o.model_error("rotate - id not found: " + e);
            var l = o.models[o.models_ref[e]];
            if (l) {
              var s = n ? 1 : 0;
              void 0 !== t &&
                ((l.rotationx = t + l.mesh.rotation.x * s),
                (l.mesh.rotation.x = l.rotationx)),
                void 0 !== a &&
                  ((l.rotationy = a + l.mesh.rotation.y * s),
                  (l.mesh.rotation.y = l.rotationy)),
                void 0 !== i &&
                  ((l.rotationz = i + l.mesh.rotation.z * s),
                  (l.mesh.rotation.z = l.rotationz)),
                l.mesh.updateMatrixWorld(),
                l.edges && o.set_or_update_geo_edges(l, !0);
            }
          }),
          (this.rotate = function (e, t, a, i) {
            o.set_rotation(e, t, a, i, !0);
          }),
          (this.basename = function (e) {
            return e.split(/[\\\/]/).pop();
          }),
          (this.get_model_filename = function (e, t, a, i) {
            var n = null;
            return (
              e.orig_url && !i
                ? (n = decodeURIComponent(e.orig_url))
                : e.orig_filename
                ? (n = e.orig_filename)
                : e.temp_filename
                ? (n = e.temp_filename)
                : e.local_file
                ? e.local_file.name && (n = e.local_file.name)
                : e.filename &&
                  (e.filename instanceof File && (n = File.name),
                  (n = e.filename)),
              !n && t
                ? "model_" + e.id + ".stl"
                : n
                ? (a && (n = o.basename(n)), n)
                : null
            );
          }),
          (this.add_model = function (e, t) {
            if (Array.isArray(e)) return o.add_models(e);
            if (!o.ready)
              return (
                o.models_to_add.push(e),
                o.model_error("THREE JS files are not ready")
              );
            var a = o.get_model_filename(e);
            if (a)
              switch (a.split(".").pop()) {
                case "vsj":
                  return o.load_vsj(e.local_file ? e.local_file : a);
                case "vsb":
                  return o.load_vsb(e.local_file ? e.local_file : a);
              }
            void 0 === e.id && (e.id = -1);
            var i = o.error_in_model(e);
            if (i) return i;
            -1 == e.id && (e.id = ++o.max_model_id), o.models.push(e);
            var n = o.models.indexOf(e);
            return (
              t || (void 0 === o.models_ref[e.id] && o.models_count++),
              (o.models_ref[e.id] = n),
              o.load_model(e),
              o.status
            );
          }),
          (this.add_models = function (e) {
            if (!Array.isArray(e)) return o.add_model(e);
            o.status = 0;
            var t = Object.keys(e);
            return (
              t.forEach(function (a) {
                var i = o.get_model_filename(e[t[a]]);
                if (i)
                  switch (i.split(".").pop()) {
                    case "vsj":
                    case "vsb":
                      break;
                    default:
                      void 0 === o.models_ref[e[a].id] && o.models_count++;
                  }
                else void 0 === o.models_ref[e[a].id] && o.models_count++;
              }),
              t.forEach(function (t) {
                o.add_model(e[t], !0);
              }),
              o.status
            );
          }),
          (this.calc_volume_and_area = function (e, t) {
            var o,
              a,
              i,
              n,
              l,
              s,
              r,
              d,
              _,
              c,
              m,
              u,
              f,
              h,
              p = e.faces.length,
              g = 0,
              v = 0;
            for (c = 0; c < p; c++)
              (o = e.vertices[e.faces[c].a].x * t),
                (n = e.vertices[e.faces[c].a].y * t),
                (r = e.vertices[e.faces[c].a].z * t),
                (a = e.vertices[e.faces[c].b].x * t),
                (l = e.vertices[e.faces[c].b].y * t),
                (d = e.vertices[e.faces[c].b].z * t),
                (g +=
                  -(i = e.vertices[e.faces[c].c].x * t) * l * r +
                  a * (s = e.vertices[e.faces[c].c].y * t) * r +
                  i * n * d -
                  o * s * d -
                  a * n * (_ = e.vertices[e.faces[c].c].z * t) +
                  o * l * _),
                (h =
                  ((m =
                    e.vertices[e.faces[c].a].distanceTo(
                      e.vertices[e.faces[c].b]
                    ) * t) +
                    (u =
                      e.vertices[e.faces[c].b].distanceTo(
                        e.vertices[e.faces[c].c]
                      ) * t) +
                    (f =
                      e.vertices[e.faces[c].c].distanceTo(
                        e.vertices[e.faces[c].a]
                      ) * t)) /
                  2),
                (v += Math.sqrt(h * (h - m) * (h - u) * (h - f)));
            return [Math.abs(g / 6), v, e.faces.length];
          }),
          (this.get_model_info = function (e) {
            if (void 0 === o.models_ref[e])
              return o.model_error("get_model_info - id not found: " + e);
            var t = o.models[o.models_ref[e]];
            if (!t) return null;
            if (!t.mesh) return null;
            if (!t.mesh.geometry) return null;
            var a = t.mesh.geometry
              ? o.calc_volume_and_area(
                  t.mesh.geometry,
                  "inch" == t.units ? 1 / 25.4 : 1
                )
              : [0, 0, 0];
            return {
              name: t.filename
                ? t.filename
                : t.local_file
                ? t.local_file.name
                : "",
              orig_filename: t.orig_filename ? t.orig_filename : null,
              position: { x: t.x, y: t.y, z: t.z },
              dims: {
                x: t.mesh.geometry.maxx - t.mesh.geometry.minx,
                y: t.mesh.geometry.maxy - t.mesh.geometry.miny,
                z: t.mesh.geometry.maxz - t.mesh.geometry.minz,
              },
              rotation: {
                x: t.mesh.rotation.x,
                y: t.mesh.rotation.y,
                z: t.mesh.rotation.z,
              },
              display: t.display ? t.display : null,
              color: t.color ? t.color : null,
              scale: { x: t.scalex, y: t.scaley, z: t.scalez },
              volume: a[0],
              area: a[1],
              triangles: a[2],
              units: t.units,
              opacity: void 0 !== t.opacity ? t.opacity : 1,
            };
          }),
          (this.get_vsb = function () {
            var e = [];
            return (
              Object.keys(o.models_ref).forEach(function (t) {
                e.push({ id: t, bin: o.get_stl_bin(t) });
              }),
              { vsj: o.get_vsj(!0, !0, !0), files: e }
            );
          }),
          (this.get_vsj = function (e, t, a) {
            o.camera.position;
            var i = {
              canvas_height: o.canvas_height,
              bg_color: o.bg_color,
              camera_state: o.get_camera_state(),
              auto_rotate: o.auto_rotate,
              mouse_zoom: o.mouse_zoom,
              auto_resize: o.auto_resize,
              center_models: o.center_models,
            };
            return (
              o.grid && (i.grid = 1),
              (i.models = []),
              Object.keys(o.models_ref).forEach(function (e) {
                var n = o.models[o.models_ref[e]],
                  l = { id: a ? -1 : n.id };
                if (a) l.filename = n.id + ".stl";
                else {
                  var s = o.get_model_filename(n, !0, t);
                  s && (l.filename = s),
                    n.local_file && (l.local_file = n.local_file);
                }
                n.x && (l.x = n.x),
                  n.y && (l.y = n.y),
                  n.z && (l.z = n.z),
                  n.display && (l.display = n.display),
                  (n.colors && "#ffffff" == n.color) ||
                    (n.color && (l.color = n.color)),
                  n.units && (l.units = n.units),
                  n.rotationx && (l.rotationx = n.rotationx),
                  n.rotationy && (l.rotationy = n.rotationy),
                  n.rotationz && (l.rotationz = n.rotationz),
                  void 0 === n.scale ||
                    a ||
                    (1 != n.scale && (l.scale = n.scale)),
                  1 == n.scalex || a || (l.scalex = n.scalex),
                  1 == n.scaley || a || (l.scaley = n.scaley),
                  1 == n.scalez || a || (l.scalez = n.scalez),
                  void 0 !== n.opacity &&
                    1 != n.opacity &&
                    (l.opacity = n.opacity),
                  n.view_edges && (l.view_edges = n.view_edges),
                  n.animation &&
                    ((l.animation = JSON.parse(JSON.stringify(n.animation))),
                    delete l.animation.start_time,
                    delete l.animation.last_time),
                  (i.models[o.models_ref[e]] = l);
              }),
              e ? i : o.json_without_nulls(i)
            );
          }),
          (this.download_vsj = function (e) {
            var t = new Blob([o.get_vsj()], { type: "application/json" }),
              a = document.createElement("a");
            a.href = window.URL.createObjectURL(t);
            var i = e || "1",
              n = i.toLowerCase().indexOf(".vsj");
            n >= 0 && (i = i.substring(0, n)),
              i.length < 1 && (i = "1"),
              window.navigator.msSaveOrOpenBlob
                ? window.navigator.msSaveBlob(t, i + ".vsj")
                : ((a.download = i + ".vsj"),
                  a.click(),
                  URL.revokeObjectURL(a.href));
          }),
          (this.load_vsj = function (e) {
            if (!e)
              return o.pre_loaded_vsj
                ? (stl_viewer.init_by_json(o.pre_loaded_vsj),
                  (o.pre_loaded_vsj = null),
                  !0)
                : o.model_error(
                    "load_vsj - invalid filename" + e,
                    o.load_error_callback
                  );
            if (e instanceof File)
              return o.read_bin_file(e, o.init_by_json, null, !0);
            var t = new XMLHttpRequest();
            (t.onreadystatechange = function (e) {
              4 == t.readyState &&
                200 == t.status &&
                o.init_by_json(t.response.trim());
            }),
              t.open("GET", e, !0),
              t.send(null);
          }),
          (this.padend = function (e, t, o) {
            return (
              (t >>= 0),
              (o = String(void 0 !== o ? o : " ")),
              e.length > t
                ? String(e)
                : ((t -= e.length) > o.length && (o += o.repeat(t / o.length)),
                  String(e) + o.slice(0, t))
            );
          }),
          (this.get_normal = function (e, t, o) {
            var a = t.x - e.x,
              i = t.y - e.y,
              n = t.z - e.z,
              l = o.x - e.x,
              s = o.y - e.y,
              r = o.z - e.z,
              d = { x: 0, y: 0, z: 0 };
            (d.x = i * r - n * s), (d.y = n * l - a * r), (d.z = a * s - i * l);
            var _ = Math.sqrt(d.x * d.x + d.y * d.y + d.z * d.z);
            return 0 != _ && ((d.x /= _), (d.y /= _), (d.z /= _)), d;
          }),
          (this.get_stl_bin = function (e) {
            if (void 0 === o.models_ref[e])
              return o.model_error("get_stl_bin - id not found: " + e);
            var t = o.models[o.models_ref[e]];
            if (t && t.mesh) {
              var a = t.mesh.geometry;
              if (a) {
                for (
                  var i = new ArrayBuffer(84 + 50 * a.faces.length),
                    n = new DataView(i),
                    l =
                      (new TextEncoder(),
                      o.padend(
                        "Binary" +
                          (t.colors ? " colored" : "") +
                          " STL by viewstl.com",
                        80,
                        " "
                      )),
                    s = 0;
                  s < 80;
                  s++
                )
                  n.setUint8(s, l.charCodeAt(s), !0);
                n.setUint32(80, a.faces.length, !0);
                var r = 84;
                return (
                  Object.keys(a.faces).forEach(function (e) {
                    var i = a.faces[e],
                      l = a.vertices[i.a],
                      s = a.vertices[i.b],
                      d = a.vertices[i.c],
                      _ = o.get_normal(l, s, d);
                    n.setFloat32(r, _.x, !0),
                      (r += 4),
                      n.setFloat32(r, _.y, !0),
                      (r += 4),
                      n.setFloat32(r, _.z, !0),
                      (r += 4),
                      n.setFloat32(r, l.x, !0),
                      (r += 4),
                      n.setFloat32(r, l.y, !0),
                      (r += 4),
                      n.setFloat32(r, l.z, !0),
                      (r += 4),
                      n.setFloat32(r, s.x, !0),
                      (r += 4),
                      n.setFloat32(r, s.y, !0),
                      (r += 4),
                      n.setFloat32(r, s.z, !0),
                      (r += 4),
                      n.setFloat32(r, d.x, !0),
                      (r += 4),
                      n.setFloat32(r, d.y, !0),
                      (r += 4),
                      n.setFloat32(r, d.z, !0),
                      (r += 4),
                      t.colors
                        ? n.setUint16(
                            r,
                            Math.ceil(31 * i.color.r) |
                              (Math.ceil(31 * i.color.g) << 5) |
                              (Math.ceil(31 * i.color.b) << 10),
                            !0
                          )
                        : n.setUint16(r, 0, !0),
                      (r += 2);
                  }),
                  i
                );
              }
            }
          }),
          (this.basename = function (e) {
            return e.substr(e.lastIndexOf("/") + 1);
          }),
          (this.json_without_nulls = function (e) {
            return JSON.stringify(e)
              .split(",null")
              .join("")
              .split("null,")
              .join("");
          }),
          (this.get_vsb_blob = function () {
            var e = null;
            try {
              e = new JSZip();
            } catch (e) {
              return (
                console.log("download_vsb - JSZip is missing ", e.message), !1
              );
            }
            var t = o.get_vsb();
            return (
              e.file("json_data.vsj", o.json_without_nulls(t.vsj)),
              Object.keys(t.files).forEach(function (a) {
                var i = o.get_model_filename(
                  t.vsj.models[o.models_ref[t.files[a].id]],
                  !0,
                  !0
                );
                e.file(i, t.files[a].bin);
              }),
              e.generateAsync({ type: "blob" })
            );
          }),
          (this.download_vsb = function (e) {
            o.get_vsb_blob(e).then(function (t) {
              var o = new Blob([t], { type: "application/zip" }),
                a = document.createElement("a");
              a.href = window.URL.createObjectURL(o);
              var i = e || "1",
                n = i.toLowerCase().indexOf(".vsb");
              n >= 0 && (i = i.substring(0, n)),
                i.length < 1 && (i = "1"),
                window.navigator.msSaveOrOpenBlob
                  ? window.navigator.msSaveBlob(o, i + ".vsb")
                  : ((a.download = i + ".vsb"),
                    a.click(),
                    URL.revokeObjectURL(a.href));
            });
          }),
          (this.load_vsb = function (e) {
            if (
              ((o.pre_loaded_ab_files = []),
              (o.pre_loaded_vsj = null),
              e instanceof File)
            )
              return o.read_bin_file(e, o.load_vsb_from_blob);
            JSZipUtils.getBinaryContent(decodeURIComponent(e), function (e, t) {
              if (e)
                return o.model_error("load_vsb " + e, o.load_error_callback);
              o.load_vsb_from_blob(t);
            });
          }),
          (this.read_bin_file = function (e, t, o, a) {
            var i = new FileReader();
            (i.onerror = function (e) {
              return console.log("reading file error", e), null;
            }),
              (i.onload = function (e) {
                return t(e.target.result);
              }),
              o &&
                (i.onprogress = function (e) {
                  o({ loaded: e.loaded, total: e.total, load_session: -1 }, -1);
                }),
              a ? i.readAsText(e) : i.readAsArrayBuffer(e);
          }),
          (this.load_vsb_from_blob = function (e) {
            var t = null;
            try {
              t = new JSZip();
            } catch (e) {
              return console.log("load vsb - JSZip is missing ", e.message), !1;
            }
            t.loadAsync(e).then(function () {
              (o.zip_load_count = Object.keys(t.files).length),
                t.forEach(function (e, a) {
                  "json_data.vsj" == a.name
                    ? t.files[a.name].async("string").then(function (e) {
                        (o.pre_loaded_vsj = e),
                          o.zip_load_count--,
                          0 == o.zip_load_count && o.load_vsj(null);
                      })
                    : t.files[a.name].async("blob").then(function (e) {
                        (o.pre_loaded_ab_files[a.name] = e),
                          o.zip_load_count--,
                          0 == o.zip_load_count && o.load_vsj(null);
                      });
                });
            });
          }),
          (this.download_model = function (e, t) {
            if (void 0 === o.models_ref[e])
              return o.model_error("download_model - id not found: " + e);
            var a = o.models[o.models_ref[e]];
            if (a && a.mesh) {
              var i = new Blob([o.get_stl_bin(e)], { type: "application/sla" }),
                n = document.createElement("a");
              n.href = window.URL.createObjectURL(i);
              var l = o.get_model_filename(a, !0, !0, !0),
                s = l.toLowerCase().indexOf(".stl");
              s >= 0 && (l = l.substring(0, s)),
                l.length < 1 && (l = "1"),
                window.navigator.msSaveOrOpenBlob
                  ? window.navigator.msSaveBlob(i, l + ".stl")
                  : ((n.download = l + ".stl"),
                    n.click(),
                    URL.revokeObjectURL(n.href));
            }
          }),
          (this.get_model_mesh = function (e) {
            if (void 0 === o.models_ref[e])
              return o.model_error("get_model_mesh - id not found: " + e);
            var t = o.models[o.models_ref[e]];
            if (t && t.mesh) {
              var a = t.mesh.clone();
              return (
                (a.geometry = t.mesh.geometry.clone()),
                (a.material = t.mesh.material.clone()),
                a
              );
            }
          }),
          (this.set_auto_rotate = function (e) {
            o.controls.autoRotate = e;
          }),
          (this.set_mouse_zoom = function (e) {
            o.controls.noZoom = !e;
          }),
          (this.WORLD_X_VECTOR = null),
          (this.WORLD_Y_VECTOR = null),
          (this.WORLD_Z_VECTOR = null),
          (this.maxx = null),
          (this.maxy = null),
          (this.maxz = null),
          (this.minx = null),
          (this.miny = null),
          (this.minz = null),
          (this.edges_material = null),
          (this.raycaster = null),
          (this.mouse = null),
          (this.scene = null),
          (this.is_webgl = null),
          (this.renderer = null),
          (this.camera = null),
          (this.ambientLight = null),
          (this.directionalLight = null),
          (this.pointLight = null),
          (this.controls = null),
          (this.do_resize = function () {
            if (o.parent_element) {
              var e = o.parent_element.getBoundingClientRect(),
                t = e.width,
                a = e.height;
              (o.camera.aspect = t / a),
                o.camera.updateProjectionMatrix(),
                o.renderer.setSize(t, a);
            }
          }),
          (this.animation = []),
          (this.animate = function () {
            o.killsign ||
              (Object.keys(o.animation).forEach(function (e) {
                void 0 !== o.models_ref[e] &&
                  o.do_model_animation(o.models[o.models_ref[e]]);
              }),
              requestAnimationFrame(o.animate),
              o.renderer && o.renderer.render(o.scene, o.camera),
              o.controls && o.controls.update());
          }),
          (this.do_model_animation = function (e) {
            if (e.animation) {
              var t = Date.now();
              if (
                (e.animation.start_time || (e.animation.start_time = t),
                e.animation.delta)
              ) {
                var a = (t - e.animation.start_time) / e.animation.delta.msec,
                  i = e.animation.last_time
                    ? (t - e.animation.last_time) / e.animation.delta.msec
                    : a;
                if ((o.animation_next_delta(e, e.animation.delta, i), a >= 1)) {
                  if (!e.animation.delta.loop)
                    return void o.remove_model_animation(e, !0);
                  e.animation.delta.start_time = null;
                }
              }
              if (e.animation.exact) {
                i =
                  (t -
                    (e.animation.last_time
                      ? e.animation.last_time
                      : e.animation.start_time)) /
                  e.animation.exact.msec;
                if (
                  (o.animation_next_exact(e, e.animation.exact, i),
                  t >= e.animation.start_time + e.animation.exact.msec)
                )
                  return void o.remove_model_animation(e, !1, !0);
              }
              e.animation.last_time = t;
            }
          }),
          (this.animation_next_delta = function (e, t, a) {
            var i = !1,
              n = !1,
              l = !1;
            Object.keys(t).forEach(function (s) {
              switch (s) {
                case "x":
                case "y":
                case "z":
                  i ||
                    ((i = !0),
                    o.set_position(
                      e.id,
                      e.x + (void 0 !== t.x ? t.x * a : 0),
                      e.y + (void 0 !== t.y ? t.y * a : 0),
                      e.z + (void 0 !== t.z ? t.z * a : 0)
                    ));
                  break;
                case "rotationx":
                case "rotationy":
                case "rotationz":
                  n ||
                    ((n = !0),
                    o.rotate(
                      e.id,
                      void 0 !== t.rotationx ? t.rotationx * a : 0,
                      void 0 !== t.rotationy ? t.rotationy * a : 0,
                      void 0 !== t.rotationz ? t.rotationz * a : 0
                    ));
                  break;
                case "scale":
                case "scalex":
                case "scaley":
                case "scalez":
                  l ||
                    ((l = !0),
                    (t.scalex = t.scalex ? t.scalex : t.scale ? t.scale : null),
                    (t.scaley = t.scaley ? t.scaley : t.scale ? t.scale : null),
                    (t.scalez = t.scalez ? t.scalez : t.scale ? t.scale : null),
                    o.set_scale(
                      e.id,
                      e.scalex + (void 0 !== t.scalex ? t.scalex * a : 0),
                      e.scaley + (void 0 !== t.scaley ? t.scaley * a : 0),
                      e.scalez + (void 0 !== t.scalez ? t.scalez * a : 0)
                    ));
              }
            });
          }),
          (this.animation_next_exact = function (e, t, a) {
            var i = !1,
              n = !1,
              l = !1;
            Object.keys(t).forEach(function (s) {
              switch (s) {
                case "x":
                case "y":
                case "z":
                  i ||
                    ((i = !0),
                    void 0 === t.xtotal && (t.xtotal = t.x - e.x),
                    void 0 === t.ytotal && (t.ytotal = t.y - e.y),
                    void 0 === t.ztotal && (t.ztotal = t.z - e.z),
                    o.set_position(
                      e.id,
                      e.x + (void 0 !== t.x ? t.xtotal * a : 0),
                      e.y + (void 0 !== t.y ? t.ytotal * a : 0),
                      e.z + (void 0 !== t.z ? t.ztotal * a : 0)
                    ));
                  break;
                case "rotationx":
                case "rotationy":
                case "rotationz":
                  if (!n) {
                    n = !0;
                    var r = e.mesh.getWorldRotation();
                    void 0 === t.rotxtotal && (t.rotxtotal = t.rotationx - r.x),
                      void 0 === t.rotytotal &&
                        (t.rotytotal = t.rotationy - r.y),
                      void 0 === t.rotztotal &&
                        (t.rotztotal = t.rotationz - r.z),
                      o.rotate(
                        e.id,
                        void 0 !== t.rotationx ? t.rotxtotal * a : 0,
                        void 0 !== t.rotationy ? t.rotytotal * a : 0,
                        void 0 !== t.rotationz ? t.rotztotal * a : 0
                      );
                  }
                  break;
                case "scale":
                case "scalex":
                case "scaley":
                case "scalez":
                  l ||
                    ((l = !0),
                    (t.scalex = t.scalex ? t.scalex : t.scale ? t.scale : null),
                    (t.scaley = t.scaley ? t.scaley : t.scale ? t.scale : null),
                    (t.scalez = t.scalez ? t.scalez : t.scale ? t.scale : null),
                    void 0 === t.scalextotal &&
                      (t.scalextotal = t.scalex - e.scalex),
                    void 0 === t.scaleytotal &&
                      (t.scaleytotal = t.scaley - e.scaley),
                    void 0 === t.scaleztotal &&
                      (t.scaleztotal = t.scalez - e.scalez),
                    o.set_scale(
                      e.id,
                      e.scalex + (void 0 !== t.scalex ? t.scalextotal * a : 0),
                      e.scaley + (void 0 !== t.scaley ? t.scaleytotal * a : 0),
                      e.scalez + (void 0 !== t.scalez ? t.scaleztotal * a : 0)
                    ));
              }
            });
          }),
          (this.remove_model_animation = function (e, t, a) {
            t && (e.animation.delta = null),
              a && (e.animation.exact = null),
              e.animation.delta ||
                e.animation.exact ||
                ((e.animation = null), delete o.animation[e.id]);
          }),
          (this.animate_model = function (e, t) {
            if (void 0 === o.models_ref[e])
              return o.model_error("animate-model - id not found: " + e);
            var a = o.models[o.models_ref[e]];
            if (a) {
              if (!t) return o.remove_model_animation(a, !0, !0);
              (a.animation = JSON.parse(JSON.stringify(t))),
                a.animation.delta &&
                  (a.animation.delta.msec || (a.animation.delta.msec = 300)),
                a.animation.exact &&
                  (a.animation.exact.msec || (a.animation.exact.msec = 300)),
                (o.animation[e] = 1);
            }
          }),
          (this.init_done = !1),
          (this.init = function () {
            if (!o.init_done) {
              switch (
                ((o.WORLD_X_VECTOR = new THREE.Vector3(1, 0, 0)),
                (o.WORLD_Y_VECTOR = new THREE.Vector3(0, 1, 0)),
                (o.WORLD_Z_VECTOR = new THREE.Vector3(0, 0, 1)),
                (o.edges_material = new THREE.LineBasicMaterial({ color: 0 })),
                (o.raycaster = new THREE.Raycaster()),
                (o.mouse = new THREE.Vector2()),
                (o.scene = new THREE.Scene()),
                (o.is_webgl = webgl_Detector.webgl),
                (o.renderer = o.is_webgl
                  ? new THREE.WebGLRenderer({
                      preserveDrawingBuffer: !0,
                      alpha: !0,
                    })
                  : new THREE.CanvasRenderer({ alpha: !0 })),
                (o.camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1e5)),
                o.parent_element.appendChild(o.renderer.domElement),
                o.scene.add(o.camera),
                (o.ambientLight = new THREE.AmbientLight(2105376)),
                o.camera.add(o.ambientLight),
                (o.directionalLight = new THREE.DirectionalLight(
                  16777215,
                  0.75
                )),
                (o.directionalLight.position.x = 1),
                (o.directionalLight.position.y = 1),
                (o.directionalLight.position.z = 2),
                o.directionalLight.position.normalize(),
                o.camera.add(o.directionalLight),
                (o.pointLight = new THREE.PointLight(16777215, 0.3)),
                (o.pointLight.position.x = 0),
                (o.pointLight.position.y = -25),
                (o.pointLight.position.z = 10),
                o.camera.add(o.pointLight),
                o.controls_type)
              ) {
                case 1:
                  o.controls = new THREE.TrackballControls(
                    o.camera,
                    o.renderer.domElement
                  );
                  break;
                default:
                  (o.controls = new THREE.OrbitControls(
                    o.camera,
                    o.renderer.domElement
                  )),
                    (o.controls.autoRotate = o.auto_rotate);
              }
              o.set_on_model_mousedown(o.onmousedown_callback);
            }
            o.set_bg_color(o.bg_color),
              !1 === o.mouse_zoom && o.set_mouse_zoom(o.mouse_zoom),
              o.camera_state
                ? o.set_camera_state(o.camera_state)
                : o.camera.position.set(o.camerax, o.cameray, o.cameraz),
              o.do_resize(),
              o.models_to_add && o.add_models(o.models_to_add),
              o.set_auto_resize(o.auto_resize),
              o.animate(),
              (o.init_done = !0);
          }),
          (this.set_auto_resize = function (e) {
            o.do_resize &&
              (window.removeEventListener("resize", o.do_resize),
              e && window.addEventListener("resize", o.do_resize));
          }),
          (this.vf_to_geo = function (e, t, a, n) {
            if (!e) return null;
            if (!t) return null;
            var l = [],
              s = [],
              r = e.length;
            for (i = 0; i < r; i++)
              l.push(new THREE.Vector3(e[i][0], e[i][1], e[i][2]));
            r = t.length;
            if (a)
              for (i = 0; i < r; i++) {
                var d = new THREE.Face3(t[i][0], t[i][1], t[i][2]);
                void 0 === t[i][3]
                  ? (n || (n = o.default_face_color),
                    d.color.setRGB(
                      parseInt(o.default_face_color.substr(1, 2), 16) / 255,
                      parseInt(o.default_face_color.substr(3, 2), 16) / 255,
                      parseInt(o.default_face_color.substr(5, 2), 16) / 255
                    ))
                  : d.color.setRGB(t[i][3], t[i][4], t[i][5]),
                  s.push(d);
              }
            else
              for (i = 0; i < r; i++)
                s.push(new THREE.Face3(t[i][0], t[i][1], t[i][2]));
            var _ = new THREE.Geometry();
            return (
              (_.vertices = l),
              (_.faces = s),
              _.computeBoundingBox(),
              _.computeFaceNormals(),
              _.computeVertexNormals(),
              o.center_models && _.center(_),
              _
            );
          }),
          (this.set_geo_minmax = function (e) {
            var t = e.mesh.geometry;
            if (t.boundingBox)
              (t.minx = t.boundingBox.min.x),
                (t.miny = t.boundingBox.min.y),
                (t.minz = t.boundingBox.min.z),
                (t.maxx = t.boundingBox.max.x),
                (t.maxy = t.boundingBox.max.y),
                (t.maxz = t.boundingBox.max.z);
            else {
              for (
                var o = t.vertices,
                  a = o[0].x,
                  i = o[0].y,
                  n = o[0].z,
                  l = o[0].x,
                  s = o[0].y,
                  r = o[0].z,
                  d = o.length;
                d--;

              )
                o[d].x < a && (a = o[d].x),
                  o[d].y < i && (i = o[d].y),
                  o[d].z < n && (n = o[d].z),
                  o[d].x > l && (l = o[d].x),
                  o[d].y > s && (s = o[d].y),
                  o[d].z > r && (r = o[d].z);
              (t.minx = a + e.x),
                (t.miny = i + e.y),
                (t.minz = n + e.z),
                (t.maxx = l + e.x),
                (t.maxy = s + e.y),
                (t.maxz = r + e.z);
            }
          }),
          (this.handleDragOver = function (e) {
            e.stopPropagation(),
              e.preventDefault(),
              (e.dataTransfer.dropEffect = "copy");
          }),
          (this.handleFileDrop = function (e) {
            e.stopPropagation(),
              e.preventDefault(),
              e.dataTransfer.files.length > 0
                ? o.load_local_files(e.dataTransfer.files)
                : "string" == typeof e.dataTransfer.getData("Text") &&
                  (o.add_model({
                    id: -1,
                    filename: e.dataTransfer.getData("Text"),
                  }),
                  o.on_model_drop &&
                    o.on_model_drop(e.dataTransfer.getData("Text")));
          }),
          (this.load_local_files = function (e) {
            if (e.length > 0) {
              for (var t = [], a = e.length, i = 0; i < a; i++) {
                switch (e[i].name.split(".").pop()) {
                  case "vsj":
                    o.load_vsj(e[i]);
                    break;
                  case "vsb":
                    o.load_vsb(e[i]);
                    break;
                  default:
                    t.push({ id: -1, local_file: e[i] });
                }
                o.on_model_drop && o.on_model_drop(e[i].name);
              }
              o.add_models(t);
            }
          }),
          (this.clean = function () {
            if (
              ((o.models = null),
              (o.models = []),
              (o.models_count = 0),
              (o.models_ref = null),
              (o.models_ref = []),
              (o.max_model_id = 0),
              (o.load_status = null),
              (o.load_status = []),
              (o.load_session = 0),
              (o.loaded_models_arr = null),
              (o.loaded_models_arr = []),
              (o.animation = null),
              (o.animation = []),
              (o.models_to_add = null),
              (o.models_to_add = []),
              (o.options.models = null),
              o.scene)
            ) {
              var e = o.scene;
              for (i = e.children.length; i--; )
                "Mesh" === e.children[i].type &&
                  (e.children[i].geometry.dispose(),
                  e.children[i].material.dispose(),
                  e.remove(e.children[i]));
              Object.keys(o.models_ref).forEach(function (e) {
                o.set_or_update_geo_edges(o.models[o.models_ref[e]], !1);
              }),
                o.renderer.renderLists.dispose();
            }
          }),
          (this.reset_parent_element = function (e) {
            (o.parent_element = e),
              o.allow_drag_and_drop && o.set_drag_and_drop(!0),
              o.set_on_model_mousedown(o.onmousedown_callback),
              o.parent_element.appendChild(o.renderer.domElement);
          }),
          (this.scripts_loader = null),
          (this.external_files_loaded = function () {
            (o.ready = !0), o.init(), o.ready_callback && o.ready_callback();
          }),
          (this.load_three = function (e) {
            "string" != typeof o.load_three_files && (o.load_three_files = ""),
              (o.scripts_loader = new ScriptsLoader());
            var t = [
              e + "three.min.js",
              e + "webgl_detector.js",
              e + "Projector.js",
              e + "CanvasRenderer.js",
              e +
                (0 == o.controls_type
                  ? "OrbitControls.js"
                  : "TrackballControls.js"),
            ];
            o.jszip_path && t.push(o.jszip_path),
              o.jszip_utils_path && t.push(o.jszip_utils_path),
              o.scripts_loader.load_scripts(t, o.external_files_loaded);
          }),
          (this.init_by_json = function (e) {
            var t = null;
            try {
              t = JSON.parse(e);
            } catch (t) {
              return console.log("json error ", e), !1;
            }
            (o.options = t), o.set_options(), o.ready && o.init();
          }),
          (this.dispose = function () {
            o.clean(),
              (o.killsign = !0),
              o.renderer && o.renderer.render(o.scene, o.camera),
              o.controls && o.controls.update(),
              (o.animate = null),
              (o.animation = null),
              (o.error = null),
              (o.options = null),
              (o.parent_element = null),
              (o.models_to_add = null),
              (o.models = null),
              (o.models_ref = null),
              (o.model_loaded_callback = null),
              (o.all_loaded_callback = null),
              (o.load_error_callback = null),
              (o.loading_progress_callback = null),
              (o.load_status = null),
              (o.loaded_models_arr = null),
              (o.onmousedown_callback = null),
              (o.camera_state = null),
              (o.ready_callback = null),
              (o.on_model_drop = null),
              (o.pre_loaded_ab_files = null),
              (o.pre_loaded_vsj = null),
              (o.grid = null),
              (o.WORLD_X_VECTOR = null),
              (o.WORLD_Y_VECTOR = null),
              (o.WORLD_Z_VECTOR = null),
              (o.edges_material = null),
              (o.raycaster = null),
              (o.mouse = null),
              (o.renderer = null),
              (o.scene = null),
              (o.camera = null),
              (o.ambientLight = null),
              (o.directionalLight = null),
              (o.pointLight = null),
              (o.controls = null);
          }),
          o.set_options(),
          o.ready
            ? (o.init(), o.ready_callback && o.ready_callback())
            : !1 !== o.load_three_files
            ? o.load_three(o.load_three_files)
            : o.model_error("No THREE files were loaded");
      }
      function ScriptsLoader() {
        var e = this;
        (this.all_loaded_callback = null),
          (this.scripts_to_load = []),
          (this.loading_scripts = []),
          (this.loaded_scripts = []),
          (this.scripts_are_loaded = function (t) {
            var o = Object.keys(t);
            for (i = o.length; i--; )
              if (!e.loaded_scripts[e.get_full_name(t[i])]) return !1;
            return !0;
          }),
          (this.get_short_name = function (e) {
            return e ? e.substring(e.lastIndexOf("/") + 1) : "";
          }),
          (this.load_scripts = function (t, o) {
            o && (e.all_loaded_callback = o),
              Object.keys(t).forEach(function (o) {
                var a = e.get_short_name(t[o]);
                -1 == e.scripts_to_load.indexOf(a) &&
                  (e.loading_scripts[a] ||
                    e.loaded_scripts[a] ||
                    e.scripts_to_load.push(t[o]));
              }),
              e.load_files();
          }),
          (this.load_files = function () {
            if (0 != e.scripts_to_load.length)
              for (; e.scripts_to_load.length; ) {
                var t = e.scripts_to_load.shift();
                if (!e.loading_scripts[t]) {
                  e.loading_scripts[t] = 1;
                  var o = document.createElement("script");
                  return (
                    (o.onload = function () {
                      var t = e.get_short_name(o.src);
                      (e.loaded_scripts[t] = 1),
                        (e.loading_scripts[t] = 0),
                        e.load_files();
                    }),
                    (o.src = t),
                    void document.head.appendChild(o)
                  );
                }
              }
            else e.all_loaded_callback && e.all_loaded_callback();
          });
      }
      (Number.isInteger =
        Number.isInteger ||
        function (e) {
          return "number" == typeof e && isFinite(e) && Math.floor(e) === e;
        }),
        (init = (function () {
          if (!window.MSStream) {
            var e = 'https://www.viewstl.com/plugin/examples/load_stl.min.js',
              t = e?.lastIndexOf("/");
            stl_viewer_script_path = t > 0 ? e.substring(0, t + 1) : "";
          }
        })());

      var stl_viewer = new StlViewer(document.getElementById("stl_cont"), {
        models: [{ filename: "marshal.stl" }],
      });
    </script>
  </body>
</html>
